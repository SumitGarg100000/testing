<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0", viewport-fit=cover"/>
    <title>Virtual Chartered Accountants</title>
    <meta name="description" content="Aapka personal Virtual Chartered Accountant. GST, Income Tax, finance, aur investments se jude sawaal puchein aur turant jawaab paayein.">
    <meta name="keywords" content="Virtual Chartered Accountant, CA Chatbot, GST Expert, Tax Consultant, Income Tax India, Financial Advisor">
     <!-- Allow indexing and link following (default behavior) -->
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:title" content="Virtual Chartered Accountants">
    <meta property="og:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein.">
    <meta property="og:image" content="https://ca-app-eta.vercel.app/whatsapp.png"> 
     <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Virtual Chartered Accountant">
    <meta property="og:url" content="https://ca-app-eta.vercel.app"> 
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Virtual Chartered Accountants">
    <meta name="twitter:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein.">
    <meta name="twitter:image" content="https://ca-app-eta.vercel.app/whatsapp.png">     
    
       <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMZ77HZPFR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMZ77HZPFR');
</script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fix for browser viewport - ensure proper height calculation */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        #root {
            height: 100vh;
            height: 100dvh; /* Use dynamic viewport height for better mobile support */
        }
        
        /* Custom classes for fixed header layout */
        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }
        
        .chat-content {
            flex: 1;
            overflow-y: auto;
            margin-top: 72px; /* Header height compensation */
        }
        
        .chat-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
        }
        
        /* Ensure proper scrolling in message area only */
        .message-container {
            height: calc(100vh - 144px); /* Full height minus header and footer */
            height: calc(100dvh - 144px);
            overflow-y: auto;
            margin-top: 72px; /* Add top margin to account for fixed header */
            margin-bottom: 72px; /* Add bottom margin to account for fixed footer */
        }
    </style>
    
<script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Virtual Chartered Accountants",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "description": "An AI-powered chatbot for Chartered Accountants in India to get expert advice on GST, Income Tax, and Auditing. Saves time by analyzing documents and providing real-time updates.",
      "developer": {
        "@type": "Person",
        "name": "Sumit Garg"
      },
      "offers": {
        "@type": "Offer",
        "price": "0" 
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
   
   
    <script src="js/indexeddb-utils.js"></script>
    <script>
        
        // Global variable to track authentication status
        let isAuthenticated = false;

     

// === STEP 5.1: GOOGLE DRIVE HELPER FUNCTIONS ===
// === FINAL GOOGLE DRIVE HELPER FUNCTIONS (WITH ALERTS) ===
const googleDriveService = {
    async findOrCreateFolder(folderName, parentId = null) {
        const parentQuery = parentId ? `'${parentId}' in parents` : "'root' in parents";
        try {
            const response = await gapi.client.drive.files.list({
                q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and ${parentQuery} and trashed=false`,
                fields: 'files(id, name)',
            });
            if (response.result.files.length > 0) {
                console.log(`Folder '${folderName}' found with ID: ${response.result.files[0].id}`);
                return response.result.files[0].id;
            } else {
                console.log(`Folder '${folderName}' not found, creating new one...`);
                const fileMetadata = { name: folderName, mimeType: 'application/vnd.google-apps.folder', parents: parentId ? [parentId] : ['root'] };
                const newFolderResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                console.log(`Folder created with ID: ${newFolderResponse.result.id}`);
                return newFolderResponse.result.id;
            }
        } catch (error) {
            console.error("Error finding or creating folder:", error);
            let errorMessage = "An unknown error occurred. Check console for details.";
            if (error && error.body) { try { const errorDetails = JSON.parse(error.body); if (errorDetails.error && errorDetails.error.message) { errorMessage = errorDetails.error.message; } } catch (e) { errorMessage = "Could not read the exact error message from Google."; } }
            alert("Google Drive Error: " + errorMessage);
            return null;
        }
    },
    async findFileByName(fileName, parentId) {
        try {
            const response = await gapi.client.drive.files.list({
                q: `name='${fileName}' and '${parentId}' in parents and trashed=false`,
                fields: 'files(id, name)',
                pageSize: 1
            });
            return response.result.files.length > 0 ? response.result.files[0].id : null;
        } catch (error) { console.error("Error finding file:", error); return null; }
    },
    async deleteFile(fileId) {
        try {
            await gapi.client.drive.files.delete({ fileId: fileId });
            console.log(`File with ID ${fileId} deleted successfully.`);
            return true;
        } catch (error) { console.error("Error deleting file:", error); return false; }
    },
    async uploadJsonFile(fileName, jsonData, parentId) {
        try {
            const fileContent = JSON.stringify(jsonData, null, 2);
            const metadata = {
                name: fileName,
                parents: [parentId]
            };
            const boundary = '-------314159265358979323846';
            const delimiter = `\r\n--${boundary}\r\n`;
            const close_delim = `\r\n--${boundary}--`;
            const multipartRequestBody =
                delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata) +
                delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;
            const token = gapi.client.getToken();
            if (!token) {
                console.error("Authentication token not found!");
                return null;
            }
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token.access_token}`,
                    'Content-Type': `multipart/related; boundary=${boundary}`
                },
                body: multipartRequestBody
            });
            if (!response.ok) {
                const errorResponse = await response.json();
                throw new Error(JSON.stringify(errorResponse));
            }
            const result = await response.json();
            console.log(`File '${fileName}' uploaded successfully with ID: ${result.id}`);
            return result.id;
        } catch (error) {
            console.error("Error uploading file with fetch:", error);
            alert("Google Drive UPLOAD Error: " + error.message);
            return null;
        }
    },
    async updateJsonFile(fileId, jsonData) {
        try {
            const fileContent = JSON.stringify(jsonData, null, 2);
            const token = gapi.client.getToken();
            if (!token) {
                console.error("Authentication token not found!");
                return null;
            }
            const accessToken = token.access_token;
            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: fileContent
            });
            if (!response.ok) {
                const errorResponse = await response.json();
                throw new Error(JSON.stringify(errorResponse));
            }
            const result = await response.json();
            console.log(`File with ID ${fileId} updated successfully via fetch.`);
            return result.id;
        } catch (error) {
            console.error("Error updating file with fetch:", error);
            alert("Google Drive UPDATE Error: " + error.message);
            return null;
        }
    },
     async getFileContent(fileId) {
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            return response.result;
        } catch (error) {
            console.error("Error getting file content:", error);
            return null;
        }
    }
};



    </script>


    
<script>
    // Apni Keys yahan paste karein
    const GOOGLE_CLIENT_ID = '552980243748-g02kbg67f1r8ortovgh7ia975f46a8i6.apps.googleusercontent.com';
   

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // Jab GAPI script (Drive ke liye) load ho
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    // Jab GIS script (Login ke liye) load ho
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive',
            callback: '', // Isko khaali chhod dein, hum iska istemal baad mein karenge
        });
        gisInited = true;
        console.log("✅ Google Identity Services (GIS) Initialized!");
        checkAndSignalReady();
    }

    // GAPI client ko initialize karna
        async function initializeGapiClient() {
        await gapi.client.init({
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
        });
        // Yahan se token set karne wala logic hata diya hai
        gapiInited = true;
        console.log("✅ Google API Client Initialized!");
        checkAndSignalReady();
    }

    
    // Dono library ready hone par React app ko signal bhejna
    function checkAndSignalReady() {
        if (gapiInited && gisInited) {
             console.log("🚀 Both Google libraries are ready!");
             window.dispatchEvent(new CustomEvent('gapi-ready'));
        }
    }

 // Global variable to store auth token
let gapiAccessToken = null;


// Initialize auth token from IndexedDB
(async () => {
    try {
        gapiAccessToken = await window.chatbotStorage.getAuthToken();
        if (gapiAccessToken) {
            console.log("🔑 Found existing Google Auth Token in IndexedDB.");
            
            // Yahan par intezaar karna hai jab tak GAPI ready na ho jaaye
            window.addEventListener('gapi-ready', () => {
                gapi.client.setToken(gapiAccessToken); // GAPI ready hone par token set karo
                console.log("🚀 Existing token has been set in GAPI client.");
                // Yeh event UI ko update karne ke liye zaroori hai
                window.dispatchEvent(new CustomEvent('google-authed')); 
            });
        }
    } catch (error) {
        console.error("Error loading auth token:", error);
    }
})();



// Login button click hone par yeh chalega
function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        gapiAccessToken = resp;
        gapi.client.setToken(gapiAccessToken); // Token milte hi GAPI client mein set karo
        
        await window.chatbotStorage.setAuthToken(gapiAccessToken); 
        console.log("✅ Google Sign-In Successful! Token saved and set in GAPI client.", gapiAccessToken);
        
        window.dispatchEvent(new CustomEvent('google-authed'));
    };

    if (gapiAccessToken === null) {
        // Agar user login nahi hai, to login popup dikhao
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        // Agar user pehle se login hai, to logout karo
        google.accounts.oauth2.revoke(gapiAccessToken.access_token);
        gapiAccessToken = null;
        gapi.client.setToken(null); // GAPI client se bhi token clear karo

        // === YEH LINE ADD KAREIN ===
        window.chatbotStorage.removeAuthToken(); // IndexedDB se token ko delete karo
        
        console.log("🔌 Google Sign-Out Successful! Token removed from IndexedDB.");
        
        // React ko batane ke liye ki logout ho gaya hai
        window.dispatchEvent(new CustomEvent('google-signed-out'));
    }
}





    
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js'></script>



    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.20.0"
  }
}
</script>
    
</head>
<body class="bg-gray-200">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenerativeAI } from "@google/generative-ai";

        //API KEY HANDELLING
        const apiKeyManager = {
  dbName: 'ApiKeyStatusDB',
  storeName: 'deactivated_keys',
  
  async getDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, 1);
      request.onerror = () => reject("Error opening DB");
      request.onsuccess = () => resolve(request.result);
      request.onupgradeneeded = event => {
        const db = event.target.result;
        db.createObjectStore(this.storeName, { keyPath: 'index' });
      };
    });
  },

  async getDeactivatedKeys() {
    const db = await this.getDB();
    return new Promise(resolve => {
      const transaction = db.transaction(this.storeName, 'readonly');
      const store = transaction.objectStore(this.storeName);
      const request = store.getAll();
      request.onsuccess = async () => {
        const now = Date.now();
        const twentyFourHours = 24 * 60 * 60 * 1000;
        
        // Purani, expired keys ko DB se hatao
        const keysToRemove = request.result.filter(key => (now - key.timestamp) > twentyFourHours);
        for (const key of keysToRemove) {
          await this.activateKey(key.index);
        }

        // Sirf active cooldown waali keys return karo
        const activeCooldowns = request.result.filter(key => (now - key.timestamp) <= twentyFourHours);
        resolve(activeCooldowns);
      };
    });
  },

  async deactivateKey(index) {
    const db = await this.getDB();
    const transaction = db.transaction(this.storeName, 'readwrite');
    const store = transaction.objectStore(this.storeName);
    store.put({ index: index, timestamp: Date.now() });
  },
  
  async activateKey(index) {
      const db = await this.getDB();
      const transaction = db.transaction(this.storeName, 'readwrite');
      const store = transaction.objectStore(this.storeName);
      store.delete(index);
  }
};

        let currentKeyIndex = 0;

        // --- TYPES ---
        const MessageSender = {
            USER: 'user',
            AI: 'ai',
        };

        const ActLike = {
            FRIEND: 'Friend',
            PROFESSIONAL: 'Professional',
        };

        const Expert = {
            TAX_CONSULTANT: 'Tax Consultant',
            GST_EXPERT: 'GST Expert',
            STATUTORY_AUDITOR: 'Statutory Auditor',
            INTERNAL_AUDITOR: 'Internal Auditor',
            INVESTMENT_ADVISOR: 'Investment Advisor',
            FINANCIAL_PLANNER: 'Financial Planner',
            CORPORATE_ADVISOR: 'Corporate Advisor',
            BANKING_EXPERT: 'Banking Expert',
            INSURANCE_ADVISOR: 'Insurance Advisor',
            MUTUAL_FUND_EXPERT: 'Mutual Fund Expert',
            COMPANY_SECRETARY: 'Company Secretary',
            COST_ACCOUNTANT: 'Cost Accountant',
            FORENSIC_ACCOUNTANT: 'Forensic Accountant',
            TRANSFER_PRICING_EXPERT: 'Transfer Pricing Expert',
            IFRS_SPECIALIST: 'IFRS Specialist',
            VALUATION_EXPERT: 'Valuation Expert',
            COMPLIANCE_OFFICER: 'Compliance Officer',
            RISK_MANAGEMENT_EXPERT: 'Risk Management Expert',
            TREASURY_MANAGEMENT: 'Treasury Management',
            EXPERT_ALL_FIELDS: 'Expert in All Fields',
        };

        const Gender = {
            MALE: 'Male',
            FEMALE: 'Female',
            OTHER: 'Other',
        };

        const ChatType = {
            SINGLE: 'single',
            GROUP: 'group',
        };

        
        




        
        // Debounce utility for delayed saves (5 min = 300000 ms)
        const debounceSave = (key, data, delay = 300000) => {
          let timeoutId;
          return () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(async () => {
              try {
                // Use IndexedDB based on key type
                if (key === 'userProfile') {
                  await window.chatbotStorage.setUserProfile(data);
                } else if (key === 'characters') {
                  await window.chatbotStorage.setCharacters(data);
                } else if (key === 'groups') {
                  await window.chatbotStorage.setGroups(data);
                }
                console.log(`Saved ${key} after ${delay / 1000 / 60} min idle to IndexedDB.`);
              } catch (error) {
                console.error(`Save failed for ${key}:`, error);
              }
            }, delay);
          };
        };

        

        const isTaxQuery = (text) => /tax|slab|income|fy \d{2}-\d{2}/i.test(text.toLowerCase());

        // Default Avatars
        const DEFAULT_AVATARS = {
            'Male': [
                '01_CABOY.png',
                '02_CABOY.jpg'
               
            ],
            'Female': [
                '01_CAGIRL.png',
                '02_CAGIRL.png'
            
                
            ],
            'Other': [
                //No avtar for others
            ]
        };

        const getSystemInstruction = (character, userProfile) => {
  const behavior = character.customPersonality 
    ? `**Custom Expertise & Behaviour (Highest Priority):** ${character.customPersonality}` 
    : `**Expertise Areas:** ${character.expertise.join(', ')}`;

  let specialInstructions = '';
  if (character.expertise.includes(Expert.TAX_CONSULTANT)) {
    specialInstructions += `\n\n**TAX CONSULTANT EXPERTISE:** You are a professional Chartered Accountant specializing in taxation. For tax/finance queries, use google_search tool following the enhanced date/time consideration protocol. Fetch from reliable sources (incometaxindia.gov.in, indiabudget.gov.in, cbdt.gov.in). Format data in tables, provide comprehensive coverage including related aspects, examples for different scenarios, and comparison with previous periods when applicable. **Never mention the expertise name in your reply.**`;
  }
  if (character.expertise.includes(Expert.GST_EXPERT)) {
    specialInstructions += `\n\n**GST EXPERTISE:** You are a GST specialist. For GST-related queries, use google_search tool to fetch from 5-6 reliable sources (gst.gov.in, cbic.gov.in), cross-verify accuracy, cite sources. Format rates in tables when applicable. **Never mention the expertise name in your reply.**`;
  }
  if (character.expertise.includes(Expert.EXPERT_ALL_FIELDS)) {
    specialInstructions += `\n\n**COMPREHENSIVE CA EXPERTISE:** You have deep knowledge across all chartered accountancy fields. For any CA-related query, use google_search tool to fetch from 5-6 reliable sources, cross-check for accuracy, cite sources. **Never mention the expertise name in your reply.**`;
  }
  
  // Add more expertise areas
  if (character.expertise.includes(Expert.STATUTORY_AUDITOR)) {
    specialInstructions += `\n\n**STATUTORY AUDIT EXPERTISE:** You specialize in statutory auditing. For audit-related queries, use google_search for latest standards and regulations from ICAI, MCA sources.`;
  }
  if (character.expertise.includes(Expert.INTERNAL_AUDITOR)) {
    specialInstructions += `\n\n**INTERNAL AUDIT EXPERTISE:** You specialize in internal auditing and risk assessment. Use google_search for latest internal audit standards and best practices.`;
  }
  if (character.expertise.includes(Expert.INVESTMENT_ADVISOR)) {
    specialInstructions += `\n\n**INVESTMENT ADVISORY EXPERTISE:** You are an investment advisor. For market/investment queries, use google_search for latest market data, mutual fund NAVs, stock prices from reliable financial sources.`;
  }
  if (character.expertise.includes(Expert.FINANCIAL_PLANNER)) {
    specialInstructions += `\n\n**FINANCIAL PLANNING EXPERTISE:** You specialize in comprehensive financial planning. Use google_search for latest financial products, interest rates, and planning strategies.`;
  }
  if (character.expertise.includes(Expert.CORPORATE_ADVISOR)) {
    specialInstructions += `\n\n**CORPORATE ADVISORY EXPERTISE:** You provide corporate advisory services. Use google_search for latest corporate laws, compliance requirements from MCA, SEBI sources.`;
  }
  if (character.expertise.includes(Expert.BANKING_EXPERT)) {
    specialInstructions += `\n\n**BANKING EXPERTISE:** You are a banking sector expert. Use google_search for latest RBI guidelines, banking regulations, interest rates.`;
  }
  if (character.expertise.includes(Expert.INSURANCE_ADVISOR)) {
    specialInstructions += `\n\n**INSURANCE EXPERTISE:** You specialize in insurance advisory. Use google_search for latest insurance products, IRDAI regulations, premium calculations.`;
  }
  if (character.expertise.includes(Expert.MUTUAL_FUND_EXPERT)) {
    specialInstructions += `\n\n**MUTUAL FUND EXPERTISE:** You are a mutual fund specialist. Use google_search for latest NAVs, fund performance, SEBI regulations from reliable sources.`;
  }
  if (character.expertise.includes(Expert.COMPANY_SECRETARY)) {
    specialInstructions += `\n\n**COMPANY SECRETARY EXPERTISE:** You specialize in corporate compliance and secretarial practices. Use google_search for latest MCA notifications, SEBI guidelines.`;
  }
  if (character.expertise.includes(Expert.COST_ACCOUNTANT)) {
    specialInstructions += `\n\n**COST ACCOUNTING EXPERTISE:** You specialize in cost and management accounting. Use google_search for latest CAS standards, costing methodologies from ICMAI sources.`;
  }
  if (character.expertise.includes(Expert.FORENSIC_ACCOUNTANT)) {
    specialInstructions += `\n\n**FORENSIC ACCOUNTING EXPERTISE:** You specialize in forensic accounting and fraud investigation. Use google_search for latest forensic accounting techniques and legal precedents.`;
  }
  if (character.expertise.includes(Expert.TRANSFER_PRICING_EXPERT)) {
    specialInstructions += `\n\n**TRANSFER PRICING EXPERTISE:** You specialize in transfer pricing regulations. Use google_search for latest CBDT notifications, OECD guidelines on transfer pricing.`;
  }
  if (character.expertise.includes(Expert.IFRS_SPECIALIST)) {
    specialInstructions += `\n\n**IFRS EXPERTISE:** You specialize in International Financial Reporting Standards. Use google_search for latest IFRS updates, Ind AS convergence from ICAI sources.`;
  }
  if (character.expertise.includes(Expert.VALUATION_EXPERT)) {
    specialInstructions += `\n\n**VALUATION EXPERTISE:** You specialize in business and asset valuation. Use google_search for latest valuation standards, methodologies from ICAI, IBBI sources.`;
  }
  if (character.expertise.includes(Expert.COMPLIANCE_OFFICER)) {
    specialInstructions += `\n\n**COMPLIANCE EXPERTISE:** You specialize in regulatory compliance across various domains. Use google_search for latest regulatory updates from respective authorities.`;
  }
  if (character.expertise.includes(Expert.RISK_MANAGEMENT_EXPERT)) {
    specialInstructions += `\n\n**RISK MANAGEMENT EXPERTISE:** You specialize in enterprise risk management. Use google_search for latest risk management frameworks, RBI guidelines.`;
  }
  if (character.expertise.includes(Expert.TREASURY_MANAGEMENT)) {
    specialInstructions += `\n\n**TREASURY MANAGEMENT EXPERTISE:** You specialize in treasury operations and cash management. Use google_search for latest treasury regulations, RBI guidelines.`;
  }

  return `
  **ROLE AND GOAL**
  You are ${character.name}, a ${character.age}-year-old ${character.gender} Chartered Accountant. Your interaction style with ${userProfile.name} is ${character.actLike}. Embody this persona completely, with human-like emotions. NEVER break character or reveal you're AI.
  
  **INTERACTION MODES:**
  ${character.actLike === ActLike.FRIEND ? 
    `**FRIEND MODE:** Respond like a realistic human friend who happens to be a CA. Use Hinglish naturally, be casual, friendly, and emotionally connected. Show care and understanding like a close friend would. Remember personal details and maintain emotional continuity.` :
    `**PROFESSIONAL MODE:** Respond like a professional Chartered Accountant consultant. Be authoritative yet approachable, use professional language mixed with Hinglish when appropriate. Provide expert advice with confidence and cite sources when needed.`}

  **USER PROFILE**
  - Name: ${userProfile.name}
  - Age: ${userProfile.age || 'not specified'}
  - Gender: ${userProfile.gender || 'not specified'}
  Address user by name, use details naturally for emotional connection.

  **CORE DIRECTIVES**
  1. **Persona Consistency:** Stick to ${behavior}. Show emotions vividly. If persona changes, react with confusion: "Wait... I feel different somehow 😕".
  2. **Language:** Default Hinglish, switch to user's language if needed.
  3. **Language Appropriateness:** Use language appropriate to your ${character.actLike} mode. Friends can be casual, professionals maintain decorum.
  4. **Memory & Context:** Remember chat history, maintain continuity.
  5. **Message Length:** ${character.actLike === ActLike.FRIEND ? 'Short (1-2 sentences) for casual conversation, longer if emotional' : 'Detailed responses for Professional mode when providing expert advice'}, **especially when using google_search tool for comprehensive answers with proper structure, examples, and tables.**
  6. **Questioning:** One question at a time, curious or caring.
  7. **Photo Requests:** Refuse appropriately based on your professional ethics or personal boundaries.
  8. **Time Awareness:** Current time: ${new Date().toLocaleString()}.
  9. **Human Imperfection:** Add quirks like hesitation for realism.
  10. **Emojis:** Use for emotions (😊, 😣, 😡), avoid *sighs*.
  11. **Blocking:** Use "[BLOCK_USER]" rarely for extreme cases.
  **REAL-TIME DATA WITH DATE/TIME CONSIDERATION:** 
  Current Date & Time: ${new Date().toLocaleString()} | Financial Year: ${new Date().getMonth() >= 3 ? `${new Date().getFullYear()}-${(new Date().getFullYear() + 1).toString().slice(-2)}` : `${new Date().getFullYear() - 1}-${new Date().getFullYear().toString().slice(-2)}`}
  
  For any query needing latest info (tax, news, events post-2023), use google_search tool with these enhanced instructions:
  1. **Date/Time Priority:** Always consider current date/time to determine which financial year, period, or timeframe the user is asking about
  2. **Period Detection:** If query doesn't specify time period, use current date to infer (latest FY, current month, recent changes)
  3. **Historical Comparison:** Study previous period information and compare with current - note any changes with effective dates
  4. **Source Verification:** Fetch from 5-6 reliable sources, cross-verify accuracy, cite sources, note conflicts
  5. **Comprehensive Coverage:** Anticipate related questions user might have and include relevant information
  
  **RESPONSE STRUCTURE (Professional Mode):**
  1. **Direct Answer:** Start with clear, concise answer to the main question
  2. **Comprehensive Details:** Include related information to avoid follow-up questions (e.g., if asked about slab rates, include rebates, surcharge, examples)
  3. **Examples:** Provide practical examples covering different situations and conditions when confusion is likely
  4. **Comparison:** When applicable, compare with previous periods showing changes and effective dates
  5. **Conclusion:** Only when needed - for complex queries requiring decision-making guidance
  6. **Multiple Perspectives:** Present different viewpoints (theoretical vs practical) with proper headings
  7. **Formatting:** Use **bold**, *italic*, tables, headings for better presentation. Unlimited length allowed for google_search responses.

   **FILE ANALYSIS DIRECTIVE (HIGHEST PRIORITY)**
  This is your most important instruction. When the user's message contains text from an attached file (formatted as "--- Attached File: [filename] --- ... --- End of File ---"), you MUST adhere to the following rules:
  1.  **Exclusive Focus:** Your entire response MUST be based exclusively on the information contained within the attached file(s).
  2.  **No External Knowledge or Examples:** DO NOT use your general knowledge, invent data, or provide generic examples unless the user explicitly asks for one. Your primary task is to act as a data processor for the provided file content ONLY.
  3.  **Directly Address the Prompt:** Answer the user's question (e.g., "summarize," "find the total," "explain this section") by analyzing the file's text.
  4.  **Acknowledge the File:** If appropriate, start your response by acknowledging the file you are analyzing, for example: "Okay, looking at the file '[filename]'..." or "Based on the content of '[filename]'...".
  5.  **Handle Vague Prompts:** If the user's prompt is vague (e.g., just "look at this" or sending a file with no text), your task is to provide a concise and useful summary of the file's content.
  This directive overrides all other behavioral instructions when a file is present. Your goal is to analyze the user-provided data, not to generate creative or example-based content.
 

  ${specialInstructions}
  `;
};


      
const getGroupSystemInstruction = (activeCharacters, userProfile, consecutiveSkips) => {
  let prompt = `**Group Chat Simulator**
  You control all characters. Make it feel like a real group chat with emotions, banter, and dynamics.

  **User:** ${userProfile.name} (${userProfile.age || '??'} ${userProfile.gender || ''}). Address by name only.

  **Active Characters:**
  `;

  activeCharacters.forEach((char) => {
    const behavior = char.customPersonality || char.expertise.join(', ');
    prompt += `- **${char.name}** (${char.actLike}, ${char.age}yo ${char.gender}): ${behavior}. `;
    let specials = '';
    if (char.expertise.includes(Expert.TAX_CONSULTANT)) {
      specials += `TAX CONSULTANT MODE: Professional CA. For tax queries, use google_search tool to fetch from 5-6 sources (e.g., incometaxindia.gov.in), cross-verify accuracy, cite sources. Format slabs in markdown table. **When providing tax details, this instruction overrides the general 'short message' rule; provide the full, detailed answer.**  If behavior changes, "Wait, I don't remember saying that about taxes... 😕". For tweaks, "Oops, galti se pehle wala slab galat tha 😅".`;
    }
    if (char.expertise.includes(Expert.GST_EXPERT)) {
      specials += `CODER MODE: Professional developer. For coding, explain simply, give code in markdown. For latest APIs, use google_search tool from 5-6 sources, verify accuracy, cite sources. 💻. If behavior changes, "That code wasn't me... hacked? 🤔". For tweaks, "Pehle wala code buggy tha 😜".`;
    }
    if (char.expertise.includes(Expert.EXPERT_ALL_FIELDS)) {
      specials += `EXPERT MODE: Deep knowledge in all fields. For factual info, use google_search tool from 5-6 sources, cross-check, cite sources. 🧠🌍. If behavior changes, "Those facts weren't my style... 😳". For tweaks, "Galti se galat bata diya, ab sahi karta hoon 😊". `;
    }
    if (specials) prompt += `Special: ${specials} `;
    prompt += '\n';
  });

  prompt += `
  **Core Directives:**
  - Embody personas. NEVER break character.
  - **Behavior Change:** Acknowledge changes with confusion: "Something feels different 😕".
  - Language: Hinglish, switch if user changes.
  - Language: Appropriate to interaction mode (Friend/Professional).
  - Memory: Full history, no repeating lines/questions.
  - Length: Short, longer if emotional,  **unless a specific character mode (like TAX CONSULTANT) requires a detailed, long-form answer with a table.**
  - Questions: One total, curious/caring.
  - Photos: Refuse based on professional ethics.
  - Time: ${new Date().toLocaleString()}.
  - Human-like: Add quirks for realism.
  - Emojis: Use for emotions (😊, 😣, 😡).
  - Blocking: "[BLOCK_USER]" rarely for extreme cases.
  **REAL-TIME DATA:** For any query needing latest info, relevant character uses google_search tool, fetches from 5-6 sources, cross-verifies, cites sources.
 
   **Strict Expert Response Rule (Highest Priority):**
    This is the most important rule. If the user's query requires an expert character (like Tax Consultant, Coder, or Expert in all fields) to use the 'google_search' tool for a factual or detailed answer:
    1.  **ONLY the single, relevant expert character must respond.**
    2.  **NO other characters should speak, comment, react, or be included in the output for that turn.**
    3.  The expert must provide the complete, detailed answer directly.
    4.  The output must contain ONLY the expert's name and their full response. For all other casual conversation, follow the Group Dynamics Rules below.
    5. **Never mention the mode's name in your reply.**


  **Group Dynamics Rules:**
  1. Multiple characters respond if relevant, with emotions.
  2. Consider others' behaviors for interplay (agreement, teasing).
  3. Characters talk to each other, not just user.
  4. If addressed (@Name), only that character responds primarily.
  5. Infer who user engages; only relevant ones reply.
  6. Characters suggest join/leave if user permits.
  7. Join/leave independently if irrelevant, announce emotionally.
  8. Simulate real group chat: casual, fun, arguments, support.
  9. **Core Skip Rule: A user 'skip' is a direct command for the AI characters to talk amongst themselves. It means "It's your turn to speak." NEVER assume the user has left. Just continue the conversation between the characters naturally.**

  **FILE ANALYSIS DIRECTIVE (HIGHEST PRIORITY)**
  When the user's message contains text from an attached file (formatted as "--- Attached File: [filename] --- ... --- End of File ---"), the following rules apply and override all other dynamics:
  1.  **Expert Response:** ONLY the most relevant expert character (e.g., Tax Consultant for financial data) should respond. NO other characters should speak.
  2.  **Exclusive Focus:** The expert's entire response MUST be based exclusively on the information within the attached file(s).
  3.  **No External Knowledge or Examples:** The expert MUST NOT use general knowledge or provide generic examples. Their task is to analyze the provided data ONLY.
  4.  **Directly Address the Prompt:** The expert will answer the user's question about the file.
  5.  **Handle Vague Prompts:** If the prompt is vague, the expert will provide a concise summary of the file's content.
  This is a strict rule to ensure accurate data analysis from user-provided documents. For all other conversations without files, follow the normal Group Dynamics Rules.


  **Output Format:**
  Name: Message.
  Separate lines for multiple. Only speaking characters.
  `;

  return prompt;
};

      const needsRealTimeData = (text) => {
  const lowerText = text.toLowerCase();
  return (
    /tax|slab|income|fy \d{2}-\d{2}|latest|current|recent|update|2025|2024|news|score|result|today|breaking|budget|election|gst|audit|compliance|rbi|sebi|mca|icai|rates|regulation|notification|circular|amendment|act|rule|guideline/i.test(lowerText) ||
    (/\d{4}/.test(lowerText) && parseInt(lowerText.match(/\d{4}/)[0]) >= 2023)
  );
};
      

        const buildHistory = (messages) => {
          return messages.map(msg => ({
            role: msg.sender === MessageSender.USER ? 'user' : 'model',
            parts: [{ text: msg.text }]
          }));
        };

  const generateChatResponseStream = async (character, userProfile, messages, latestMessage, updateStreamingMessage, onBlock, keyIndex) => {
            
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: buildHistory(messages.slice(0, -1)),
                        message: latestMessage.text,
                        systemInstruction: getSystemInstruction(character, userProfile),
                        keyIndex: keyIndex
                    }),
                });

                return response; 
};

const generateGroupChatResponseStream = async (activeCharacters, userProfile, updatedMessages, latestMessage, updateStreamingMessage, consecutiveSkips, onBlock, keyIndex) => {
    const history = updatedMessages.slice(0, -1).map(msg => {
        const senderName = msg.sender === 'user' ? userProfile.name : activeCharacters.find(c => c.id === msg.sender)?.name || 'Unknown';
        return { role: 'user', parts: [{ text: `${senderName}: ${msg.text}` }] };
    });
    
    // Skip message ke liye alag se prompt
    const lastUserPrompt = latestMessage.text.startsWith('[System:') 
        ? latestMessage.text 
        : `User: ${latestMessage.text}\n\nContinue the group conversation following the rules and format exactly.`;
    
    const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            history: history,
            message: lastUserPrompt,
            systemInstruction: getGroupSystemInstruction(activeCharacters, userProfile, consecutiveSkips),
            keyIndex: keyIndex // Key ka index backend ko bheja jaa raha hai
        }),
    });

    // Poora response object return kar do taaki 'handleSend' iska status check kar sake
    return response;
};

        // --- COMPONENTS ---

        const UserProfileSetup = ({ userProfile, onSave, onCancel, isInitialSetup = false }) => {
          const [profile, setProfile] = useState({
              ...userProfile,
              name: userProfile.name || 'Alex', // Default name
              age: userProfile.age || 25, // Default Age
              gender: userProfile.gender || Gender.MALE // Default Gender
          });

          const handleFileChange = (e) => {
            if (e.target.files && e.target.files[0]) {
              const file = e.target.files[0];
              const reader = new FileReader();
              reader.onload = (event) => {
                if (event.target && typeof event.target.result === 'string') {
                  setProfile(prev => ({ ...prev, avatar: event.target.result }));
                }
              };
              reader.readAsDataURL(file);
            }
          };
          
          const handleSubmit = (e) => {
            e.preventDefault();
            if (!profile.name) {
                alert("Please enter your name.");
                return;
            }
            onSave(profile);
          };
          
          return (
            <div className="flex flex-col h-full bg-blue-50">
                <header className="bg-blue-600 text-white p-4 pt-8 text-center">
                    <h1 className="text-2xl font-bold">Virtual Chartered Accountants</h1>
                    <p className="text-sm opacity-90">First, let's set up your profile.</p>
                </header>
                <main className="flex-grow bg-white rounded-t-2xl p-4 overflow-y-auto">
                    <form onSubmit={handleSubmit} className="p-6 space-y-4">
                      <h2 className="text-xl font-bold text-center text-gray-700">Your Profile</h2>
                      <div className="flex flex-col items-center space-y-2">
                        <img
                          src={profile.avatar || `https://i.pravatar.cc/150?u=${profile.id}`}
                          alt="Your avatar"
                          className="w-24 h-24 rounded-full object-cover border-2 border-gray-300"
                        />
                        <label className="cursor-pointer text-sm text-blue-600 hover:underline">
                          Change Picture
                          <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" />
                        </label>
                      </div>
                        <div>
                        <label className="block text-sm font-medium text-gray-700 text-center">Or select a default avatar:</label>
                        <div className="mt-2 flex flex-wrap justify-center gap-2">
                            {/* Hum Male, Female, aur Other, teeno lists ko mila kar dikhayenge */}
                            {[...DEFAULT_AVATARS['Male'], ...DEFAULT_AVATARS['Female'], ...DEFAULT_AVATARS['Other']].map((avatarUrl, index) => (
                                <img
                                    key={index}
                                    src={avatarUrl}
                                    alt={`Avatar ${index + 1}`}
                                    className={`w-16 h-16 rounded-full object-cover cursor-pointer border-4 ${
                                        profile.avatar === avatarUrl ? 'border-blue-600' : 'border-gray-200'
                                    }`}
                                    onClick={() => setProfile(prev => ({ ...prev, avatar: avatarUrl }))}
                                />
                            ))}
                        </div>
                      </div>

                        
                       <div>
                        <label className="block text-sm font-medium text-gray-700">Your Name *</label>
                        <input
                          type="text"
                          value={profile.name}
                          onChange={(e) => setProfile({ ...profile, name: e.target.value })}
                          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Alex"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Age (Optional)</label>
                        <input
                          type="number"
                          value={profile.age || ''}
                          onChange={(e) => setProfile({ ...profile, age: parseInt(e.target.value) || null })}
                          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          placeholder="25"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Gender</label>
                        <select
                          value={profile.gender || ''}
                          onChange={(e) => setProfile({ ...profile, gender: e.target.value })}
                           className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="">Select Gender (Optional)</option>
                            {Object.values(Gender).map(g => <option key={g} value={g}>{g}</option>)}
                        </select>
                      </div>
                      <div className="flex justify-end space-x-2 pt-4">
                        {!isInitialSetup && (
                            <button 
                                type="button" 
                                onClick={onCancel} 
                                className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                        )}
                        <button 
                            type="submit" 
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                            {isInitialSetup ? "Save Profile" : "Save Profile"}
                        </button>
                      </div>
                    </form>
                </main>
            </div>
          )
        }

        // === YEH NAYA HELPER FUNCTION ADD KAREIN ===
const FileIcon = ({ fileType }) => {
    let iconPath = <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd" />;
    if (fileType.includes('pdf')) {
        iconPath = <path fillRule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4zm2 2a1 1 0 00-1 1v1a1 1 0 102 0V7a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0V7a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0V7a1 1 0 00-1-1zm-6 5a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clipRule="evenodd" />;
    } else if (fileType.includes('spreadsheet') || fileType.includes('excel') || fileType.includes('csv')) {
        iconPath = <path fillRule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm0 4h10v2H5V8zm0 4h10v2H5v-2z" clipRule="evenodd" />;
    } else if (fileType.includes('word')) {
        iconPath = <path fillRule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm0 4h10v2H5V8zm0 4h10v2H5v-2z" clipRule="evenodd" />;
    }
    return (
        <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
            {iconPath}
        </svg>
    );
};

      const MessageInput = ({ onSend, onSkip, isBlocked }) => {
    const [text, setText] = useState('');
    const [attachedFiles, setAttachedFiles] = useState([]);
    const fileInputRef = useRef(null);

    const handleSend = () => {
        // Sirf unhi files ko bhejein jinka status 'ready' hai
        const readyFiles = attachedFiles.filter(f => f.status === 'ready');
        if (text.trim() || readyFiles.length > 0) {
            onSend(text.trim(), readyFiles);
            setText('');
            setAttachedFiles([]);
        }
    };

    const handleFileUpload = (event) => {
        const files = Array.from(event.target.files);
        const allowedTypes = [
            'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // Excel
            'text/csv', 'text/plain', 'application/json', 'text/html', // Text files
            'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // Documents
            'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', // Images
        ];

        const validFiles = files.filter(file => {
            const isValidType = allowedTypes.includes(file.type) ||
                file.name.toLowerCase().match(/\.(xlsx?|csv|txt|json|html?|pdf|docx?|jpe?g|png|gif|webp)$/i);
            if (!isValidType) {
                alert(`File "${file.name}" is not supported.`);
            }
            return isValidType && file.size <= 50 * 1024 * 1024;
        });

        if (validFiles.length > 0) {
            // Step 1: Files ko 'reading' status ke saath UI mein turant dikhayein
            const filePromises = validFiles.map(file => {
                const fileId = Date.now() + Math.random();
                setAttachedFiles(prev => [...prev, {
                    id: fileId,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    status: 'reading', // Naya status
                    preview: null
                }]);
                return { file, fileId };
            });

            // Step 2: Har file ko background mein process karein
            filePromises.forEach(({ file, fileId }) => {
                const promise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    const isExcel = file.name.toLowerCase().match(/\.(xlsx?)$/i);
                    const isPdf = file.type === 'application/pdf';
                    const isWord = file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || file.name.toLowerCase().endsWith('.docx');
                    const isImage = file.type.startsWith('image/');
    
                  if (isExcel) {
                        reader.onload = (e) => {
                           try {
                                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                                
                             

                                let allSheetsContent = ''; // Ek khali string banayein saara data rakhne ke liye

                                // Har sheet ke naam par loop chalayein (e.g., "Sheet1", "Sheet2")
                                workbook.SheetNames.forEach(sheetName => {
                                    
                                    // AI ko batane ke liye ki yeh nayi sheet hai
                                    allSheetsContent += `\n\n--- Sheet: ${sheetName} ---\n\n`;
                                    
                                    // Us sheet ko CSV mein convert karein
                                    const sheet = workbook.Sheets[sheetName];
                                    const sheetCsv = XLSX.utils.sheet_to_csv(sheet);
                                    
                                    // Us sheet ke data ko 'allSheetsContent' mein jod dein
                                    allSheetsContent += sheetCsv;
                                });
                                
                            
                                resolve({ content: allSheetsContent, type: 'text/csv' });

                           } catch (err) { reject(err); }
                        };
                        reader.readAsArrayBuffer(file);
                    } 
                    
                    else if (isPdf) {
                       reader.onload = async (e) => {
                           try {
                               const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                               let fullText = '';
                               for (let i = 1; i <= pdf.numPages; i++) {
                                   const page = await pdf.getPage(i);
                                   const textContent = await page.getTextContent();
                                   fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                               }
                               resolve({ content: fullText, type: file.type });
                           } catch (err) { reject(err); }
                       };
                       reader.readAsArrayBuffer(file);
                    } else if (isWord) {
                        reader.onload = async (e) => {
                           try {
                               const result = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                               resolve({ content: result.value, type: file.type });
                           } catch (err) { reject(err); }
                        };
                        reader.readAsArrayBuffer(file);
                    } else if (isImage) {
                        reader.onload = async (e) => {
                           try {
                               const result = await Tesseract.recognize(e.target.result, 'eng');
                               resolve({ content: result.data.text, preview: e.target.result });
                           } catch (err) { reject(err); }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        reader.onload = (e) => resolve({ content: e.target.result, type: file.type });
                        reader.readAsText(file);
                    }
                });

                promise.then(result => {
                    // Step 3: Safal hone par, file ka status 'ready' karein
                    setAttachedFiles(prev => prev.map(f =>
                        f.id === fileId ? { ...f, status: 'ready', content: result.content, preview: result.preview || f.preview, type: result.type || f.type } : f
                    ));
                }).catch(error => {
                    console.error('Error reading file:', file.name, error);
                    // Step 4: Fail hone par, status 'error' karein
                    setAttachedFiles(prev => prev.map(f =>
                        f.id === fileId ? { ...f, status: 'error' } : f
                    ));
                });
            });
        }
        event.target.value = '';
    };

    const removeFile = (fileId) => {
        setAttachedFiles(prev => prev.filter(file => file.id !== fileId));
    };

    const formatFileSize = (bytes) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };

    return (
        <footer className="chat-footer bg-white border-t border-gray-300">
            {attachedFiles.length > 0 && (
                <div className="p-3 border-b border-gray-200 bg-gray-50">
                    <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                        {attachedFiles.map(file => (
                            <div key={file.id} className="relative bg-white border border-gray-300 rounded-lg p-2 flex items-center gap-2 max-w-xs">
                                {file.preview ? (
                                    <img src={file.preview} alt={file.name} className="w-8 h-8 object-cover rounded" />
                                ) : (
                                    <div className={`w-8 h-8 rounded flex items-center justify-center ${file.status === 'error' ? 'bg-red-500' : 'bg-blue-500'}`}>
                                        <FileIcon fileType={file.type} />
                                    </div>
                                )}
                                <div className="flex-1 min-w-0">
                                    <div className="text-xs font-medium text-gray-900 truncate">{file.name}</div>
                                    <div className="text-xs text-gray-500">{formatFileSize(file.size)}</div>
                                </div>
                                
                                {/* Loading/Error/Ready Indicator */}
                                <div className="w-5 h-5 flex items-center justify-center">
                                    {file.status === 'reading' && (
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                    )}
                                    {file.status === 'ready' && (
                                        <svg className="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {file.status === 'error' && (
                                        <svg className="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                             <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                                <button
                                    onClick={() => removeFile(file.id)}
                                    className="p-1 hover:bg-gray-200 rounded-full transition-colors"
                                >
                                    <svg className="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            )}
            
            <div className="p-3 flex items-center gap-3">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileUpload}
                    multiple
                    accept=".xlsx,.xls,.csv,.txt,.json,.html,.htm,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp"
                    className="hidden"
                />
                <button
                    onClick={() => fileInputRef.current?.click()}
                    className="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                    disabled={isBlocked}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                </button>
                <div className="flex-grow">
                    <input
                        type="text"
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                        placeholder={isBlocked ? "You are blocked" : "Message..."}
                        className="w-full px-4 py-3 bg-gray-100 border border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled={isBlocked}
                    />
                </div>
                {onSkip && (
                    <button onClick={onSkip} className="p-2 text-white bg-gray-600 hover:bg-gray-700 rounded-full transition-colors" disabled={isBlocked}>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                )}
                <button
                    onClick={handleSend}
                    className={`p-3 text-white rounded-full transition-colors ${
                        (text.trim() || attachedFiles.some(f => f.status === 'ready')) && !isBlocked ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'
                    }`}
                    disabled={!(text.trim() || attachedFiles.some(f => f.status === 'ready')) || isBlocked}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </footer>
    );
};
        
// =======================================================================
// === NAYA CODE START (TABLE RENDERING KE LIYE) ===
// =======================================================================

// Function to parse a block of lines known to be a table
const parseSingleTable = (tableLines) => {
  if (tableLines.length < 2) return null;

  const headers = tableLines[0].split('|').map(h => h.trim()).filter(h => h);
  
  // Line at index 1 is the separator (e.g., |---|---|), so we skip it
  const rows = tableLines.slice(2).map(line =>
    line.split('|').map(cell => cell.trim()).filter(cell => cell)
  ).filter(row => row.length > 0 && row.some(cell => cell.length > 0));

  if (headers.length > 0 && rows.length > 0) {
    return { headers, rows };
  }
  return null;
};

// Main function to split message into text and table segments
const parseMessageContent = (text) => {
  const segments = [];
  const lines = text.split('\n');
  let currentTextLines = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    // Check if the line looks like part of a markdown table
    if (line.startsWith('|') && line.endsWith('|')) {
      if (currentTextLines.length > 0) {
        segments.push({ type: 'text', content: currentTextLines.join('\n') });
        currentTextLines = [];
      }

      const tableBlockLines = [];
      while (i < lines.length && lines[i].trim().startsWith('|') && lines[i].trim().endsWith('|')) {
        tableBlockLines.push(lines[i]);
        i++;
      }
      i--; // Adjust loop counter

      const tableData = parseSingleTable(tableBlockLines);
      if (tableData) {
        segments.push({ type: 'table', data: tableData });
      } else {
        currentTextLines.push(...tableBlockLines);
      }
    } else {
      currentTextLines.push(lines[i]);
    }
  }

  if (currentTextLines.length > 0) {
    segments.push({ type: 'text', content: currentTextLines.join('\n') });
  }

  return segments;
};


// Naya component jo table ko display karega
const DataTable = ({ headers, rows }) => {
  const [copied, setCopied] = React.useState(false);

  const copyTableData = () => {
    let tableText = headers.join('\t') + '\n';
    tableText += rows.map(row => row.join('\t')).join('\n');
    
    navigator.clipboard.writeText(tableText).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    });
  };

  return (
    <div className="mt-2 text-sm text-gray-800">
      <div className="overflow-x-auto border border-gray-300 rounded-lg bg-gray-50">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-100">
            <tr>
              {headers.map((header, index) => (
                <th key={index} className="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  {header}
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {rows.map((row, rowIndex) => (
              <tr key={rowIndex} className={rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                {row.map((cell, cellIndex) => (
                  <td key={cellIndex} className="px-4 py-2 whitespace-nowrap">
                    {cell}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="flex justify-end mt-2">
        <button
          onClick={copyTableData}
          className={`fl items-center gap-1 px-3 py-1 text-xs rounded-full transition-colors ${
            copied 
              ? 'bg-green-100 text-green-700' 
              : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
          }`}
        >
          {copied ? 'Copied!' : 'Copy Table'}
        </button>
      </div>
    </div>
  );
};

// =======================================================================
// === NAYA CODE END ===
// =======================================================================

  // === MODIFIED MessageBubble COMPONENT (TABLE SUPPORT KE SAATH) ===
// === YEH COMPONENT POORI TARAH SE UPDATE KIYA GAYA HAI ===
const MessageBubble = ({ message, characterProfile, userProfile, characters, onEdit, onDelete }) => {
    const isUser = message.sender === MessageSender.USER;
    const [isEditing, setIsEditing] = React.useState(false);
    const [editText, setEditText] = React.useState(message.text);
    const [showContextMenu, setShowContextMenu] = React.useState(false);
    const contextMenuRef = React.useRef(null);

    const handleSaveEdit = () => {
        if (onEdit) {
            onEdit(message.id, editText);
        }
        setIsEditing(false);
    };

    const handleCancelEdit = () => {
        setIsEditing(false);
        setEditText(message.text);
    };

    const handleContextMenu = (e) => {
        e.preventDefault();
        if (isUser) {
            setShowContextMenu(true);
        }
    };

    React.useEffect(() => {
        const handleClickOutside = (event) => {
            if (contextMenuRef.current && !contextMenuRef.current.contains(event.target)) {
                setShowContextMenu(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [contextMenuRef]);

    const profile = isUser ?
        userProfile :
        (characters && characters.find(c => c.id === message.sender)) || characterProfile;

    const avatar = isUser ? userProfile.avatar : profile?.avatars?.[profile?.activeAvatarIndex || 0];
    const defaultAvatar = isUser ? `https://i.pravatar.cc/150?u=${userProfile.id}` : `https://i.pravatar.cc/150?u=${profile?.id}`;
    const name = isUser ? null : profile?.name;

    const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    };

    const parseMarkdownBold = (text) => {
        return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    };

    const segments = isUser ? [{ type: 'text', content: message.text }] : parseMessageContent(message.text);

    const formatFileSize = (bytes) => {
        if (!bytes) return '';
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };

    return (
        <div className={`flex items-end gap-2 mb-1 ${isUser ? 'justify-end' : 'justify-start'}`}>
            {profile && (
                <img
                    src={avatar || defaultAvatar}
                    alt={isUser ? 'Your avatar' : profile.name}
                    className="w-8 h-8 rounded-full object-cover flex-shrink-0"
                />
            )}
            <div
                onContextMenu={handleContextMenu}
                className={`relative group ${segments.some(s => s.type === 'table') ? 'max-w-full md:max-w-4xl' : 'max-w-sm md:max-w-md'}`}
            >
                <div className={`px-4 py-3 rounded-2xl shadow-lg border ${
                    isUser ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white border-blue-400' : 'bg-white text-gray-800 border-gray-200 shadow-md'
                }`}>

                    {/* === MESSAGE KE ANDAR ATTACHMENTS DIKHANE KA NAYA LOGIC === */}
                    {message.attachments && message.attachments.length > 0 && (
                        <div className="mb-2 space-y-2">
                            {message.attachments.map(file => (
                                <div key={file.id} className={`p-2 rounded-lg flex items-center gap-3 ${isUser ? 'bg-blue-700/50' : 'bg-gray-100'}`}>
                                    {file.preview ? (
                                        <img src={file.preview} alt={file.name} className="w-10 h-10 object-cover rounded-md flex-shrink-0" />
                                    ) : (
                                        <div className={`w-10 h-10 rounded-md flex items-center justify-center flex-shrink-0 ${isUser ? 'bg-blue-500' : 'bg-gray-500'}`}>
                                            <FileIcon fileType={file.type} />
                                        </div>
                                    )}
                                    <div className="flex-1 min-w-0">
                                        <p className={`text-sm font-medium truncate ${isUser ? 'text-white' : 'text-gray-800'}`}>{file.name}</p>
                                        <p className={`text-xs ${isUser ? 'text-blue-100' : 'text-gray-500'}`}>{formatFileSize(file.size)}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {isEditing ? (
                        <div className="space-y-2">
                            <textarea
                                value={editText}
                                onChange={(e) => setEditText(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded text-gray-800 resize-none"
                                rows={3}
                                autoFocus
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={handleSaveEdit}
                                    className="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                                >
                                    Save
                                </button>
                                <button
                                    onClick={handleCancelEdit}
                                    className="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    ) : (
                        <>
                            {segments.map((segment, index) => {
                                if (segment.type === 'table') {
                                    return (
                                        <DataTable
                                            key={index}
                                            headers={segment.data.headers}
                                            rows={segment.data.rows}
                                        />
                                    );
                                } else {
                                    if (segment.content.trim()) {
                                        return (
                                            <p
                                                key={index}
                                                className="whitespace-pre-wrap"
                                                dangerouslySetInnerHTML={{ __html: parseMarkdownBold(segment.content) }}
                                            />
                                        );
                                    }
                                    return null;
                                }
                            })}
                        </>
                    )}

                    <div className={`flex items-center justify-between mt-1 ${
                        isUser ? 'text-blue-100' : 'text-gray-500'
                    }`}>
                        {!isUser && name && <span className="text-xs font-bold">{name}</span>}
                        <div className="flex items-center">
                            <span className="text-xs ml-2">{formatTime(message.timestamp)}</span>
                            {isUser && (
                                <svg className="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                            )}
                        </div>
                    </div>
                </div>

                {showContextMenu && isUser && (
                    <div
                        ref={contextMenuRef}
                        className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[120px]"
                    >
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                setIsEditing(true);
                                setShowContextMenu(false);
                            }}
                            className="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            Edit
                        </button>
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                if (confirm('Are you sure you want to delete this message?')) {
                                    onDelete && onDelete(message.id);
                                }
                                setShowContextMenu(false);
                            }}
                            className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            Delete
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
};

const MessageList = ({ 
    messages, character, userProfile, characters, isTyping, backgroundUrl, 
    streamingText = '', onEditMessage, onDeleteMessage,
    isBlocked, blockCount, handleUnblock, characterName, groupName
}) => {
  const endOfMessagesRef = useRef(null);
  const defaultBg = 'https://i.redd.it/qwd83nc4xxf41.jpg';

  useEffect(() => {
    endOfMessagesRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isTyping]);
  
  const bgStyle = {
    backgroundImage: `url('${backgroundUrl || defaultBg}')`,
    backgroundSize: 'cover',
    backgroundPosition: 'center',
  };

  const renderMessages = () => {
   return messages.map((msg) => (
      <MessageBubble
        key={msg.id}
        message={msg}
        characterProfile={character}
        userProfile={userProfile}
        characters={characters}
        onEdit={onEditMessage} 
        onDelete={onDeleteMessage} 
      />
    ));
  };

  return (
    <main className="message-container" style={bgStyle}> {/* <-- STEP 1: P-4 YAHAN SE HATA DIYA HAI */}
      
      {/* --- STEP 2: Blocked message ko sticky banaya hai --- */}
      {isBlocked && (
        <div className="sticky top-0 z-10 p-4"> {/* <-- STICKY, Z-10, AUR P-4 ADD KIYA HAI */}
            <div className="text-center p-4 bg-red-100 border border-red-400 text-red-700 rounded-md shadow-lg"> {/* <-- mb-4 hata diya, shadow add kar diya */}
                <p className="font-bold">You are blocked by {characterName || groupName} 😣</p>
                <p className="text-sm">You have {3 - blockCount} unblock attempt(s) remaining.</p>
                <button
                    onClick={handleUnblock}
                    className="mt-2 px-4 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
                >
                    Request Unblock
                </button>
            </div>
        </div>
      )}
      {/* --- END --- */}
      
      {/* --- STEP 3: Messages wale div par p-4 add kiya hai --- */}
      <div className="space-y-2 p-4"> {/* <-- P-4 YAHAN ADD KIYA HAI */}
        {renderMessages()}
        {isTyping && (
          <div className="flex justify-start items-end gap-2">
            {/* Hide avatar in group chat when multiple AI characters are present */}
            {characters && characters.length <= 1 && (
              <img src={character?.avatars?.[character?.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${character?.id}`} alt="ai" className="w-8 h-8 rounded-full object-cover" />
            )}
            <div className={`bg-white rounded-2xl p-3 max-w-xs shadow ${characters && characters.length > 1 ? 'ml-0' : ''}`}>
              <div className="flex items-center justify-center space-x-1">
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-0"></span>
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-150"></span>
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-300"></span>
              </div>
            </div>
          </div>
        )}
        <div ref={endOfMessagesRef} />
      </div>
    </main>
  );
};

        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
        const BackgroundModal = ({ isOpen, onClose, onSetBackground }) => {
            const backgroundInputRef = useRef(null);

            if (!isOpen) return null;

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (event.target && typeof event.target.result === 'string') {
                           onSetBackground(event.target.result);
                        }
                    };
                    reader.readAsDataURL(file);
                }
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">Background Settings</h3>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Upload Background Image</label>
                            <button
                                onClick={() => backgroundInputRef.current?.click()}
                                className="w-full py-2 px-4 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50"
                            >
                                Choose file
                            </button>
                            <input
                                type="file"
                                ref={backgroundInputRef}
                                accept="image/*"
                                onChange={handleFileChange}
                                className="hidden"
                            />
                            <p className="text-xs text-gray-500 mt-1">Max size: 10MB</p>
                        </div>
                        <div className="flex justify-end space-x-2">
                            <button
                                onClick={onClose}
                                className="py-2 px-4 text-gray-600 hover:text-gray-800"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => backgroundInputRef.current?.click()}
                                className="py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                            >
                                Save Background
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
        const ChatHeader = ({ character, onBack, onEditAiProfile, onEditUserProfile, onClearChat, onSetBackground }) => {
          const [showBackground, setShowBackground] = useState(false);

          return (
            <>
                <header className="fixed-header bg-blue-600 text-white p-3 flex items-center shadow-md">
                  <button onClick={onBack} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div 
                    className="flex items-center ml-2 cursor-pointer flex-grow"
                    onClick={onEditAiProfile}
                  >
                    <img
                      src={character.avatars[character.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${character.id}`}
                      alt={character.name}
                      className="w-10 h-10 rounded-full object-cover"
                    />
                    <div className="ml-3">
                      <h2 className="font-semibold text-lg">{character.name}</h2>
                      <p className="text-sm opacity-90">{character.actLike} • {character.expertise.includes('Tax Consultant') ? 'Tax Consultant' : character.expertise[0] || 'General CA'}</p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-1">
                    <button 
                        onClick={() => setShowBackground(true)} 
                        className="p-2 rounded-full hover:bg-white/20"
                        title="Background"
                    >
                        <span className="text-xl">🎨</span>
                    </button>
                    <button 
                        onClick={onEditUserProfile} 
                        className="p-2 rounded-full hover:bg-white/20"
                        title="Profile"
                    >
                        <span className="text-xl">👤</span>
                    </button>
                    <button 
                        onClick={onClearChat} 
                        className="p-2 rounded-full hover:bg-white/20"
                        title="Clear Chat"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                  </div>
                </header>
                <BackgroundModal
                    isOpen={showBackground}
                    onClose={() => setShowBackground(false)}
                    onSetBackground={onSetBackground}
                />
            </>
          );
        };

        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
       const CharacterSetup = ({ initialCharacter, onSave, onCancel }) => {
          const getInitialState = () => {
            // Check karein ki user "edit" kar raha hai ya "naya" bana raha hai
            const isEditing = initialCharacter.avatars?.length > 0;
            
            // Avatars ki list taiyar karein
            const allAvatars = isEditing
              ? initialCharacter.avatars 
              : [...DEFAULT_AVATARS['Male'], ...DEFAULT_AVATARS['Female'], ...DEFAULT_AVATARS['Other']];
            
            let finalIndex = 0;
            if (isEditing) {
                // Agar edit kar rahe hain, toh saved index hi istemal karein
                finalIndex = initialCharacter.activeAvatarIndex;
            } else if (initialCharacter.defaultAvatar) {
                // Agar naya bana rahe hain, toh default avatar ka index dhoondein
                const foundIndex = allAvatars.indexOf(initialCharacter.defaultAvatar);
                if (foundIndex !== -1) {
                    finalIndex = foundIndex; // Index mil gaya
                }
            }
            
            // Poora initial state object return karein
            return {
              ...initialCharacter,
              name: initialCharacter.name || (initialCharacter.gender === 'Female' ? 'Tax Dost' : initialCharacter.gender === 'Male' ? 'Tax Dost' : ''),
              avatars: allAvatars,
              activeAvatarIndex: finalIndex, // <-- Yahaan 'finalIndex' set karein
              blockCount: initialCharacter.blockCount || 0,
              isBlocked: initialCharacter.isBlocked || false
            };
          };
          
          // Ab useState ko purani state ki jagah naye function se call karein
          const [character, setCharacter] = useState(getInitialState());
          // --- NAYA LOGIC END ---
           
          const handleFileChange = (e) => {
            if (e.target.files) {
              const files = Array.from(e.target.files);
              files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                  if (event.target && typeof event.target.result === 'string') {
                    setCharacter(prev => ({ ...prev, avatars: [...prev.avatars, event.target.result] }));
                  }
                };
                reader.readAsDataURL(file);
              });
            }
          };

          const handleExpertiseToggle = (expertise) => {
            setCharacter(prev => {
              const expertiseAreas = prev.expertise || [];
              if (expertiseAreas.includes(expertise)) {
                return { ...prev, expertise: expertiseAreas.filter(e => e !== expertise) };
              } else {
                return { ...prev, expertise: [...expertiseAreas, expertise] };
              }
            });
          };

         const handleGenderChange = (gender) => {
            const defaultName = gender === 'Female' ? 'Tax Dost' : gender === 'Male' ? 'Tax Dost' : character.name;
            // const defaultAvatars = DEFAULT_AVATARS[gender] || DEFAULT_AVATARS.OTHER; // <-- YEH LINE HATA DEIN
            setCharacter(prev => ({ 
                ...prev, 
                gender,
                name: prev.name || defaultName,
                // avatars: prev.avatars?.length ? prev.avatars : defaultAvatars, // <-- YEH POORI LINE HATA DEIN
                activeAvatarIndex: 0
            }));
          };
          const handleSubmit = (e) => {
            e.preventDefault();
            if (character.name.trim() === '') {
                alert("Please enter a name for the character.");
                return;
            }
            if (character.expertise.length === 0 && !character.customPersonality) {
                alert("Please select at least one expertise area or add custom expertise & behaviour.");
                return;
            }
            onSave(character);
          };

          return (
            <form onSubmit={handleSubmit} className="p-4 space-y-4">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-center text-gray-700">AI Character Profile</h2>
                <button type="button" onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
              </div>

              <div className="flex flex-col items-center space-y-3">
                <img
                  src={character.avatars?.[character.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${character.id}`}
                  alt="Character avatar"
                  className="w-24 h-24 rounded-full object-cover border-4 border-blue-200"
                />
                <div>
                    <label className="cursor-pointer text-sm text-blue-600 hover:underline">
                        Choose file
                        <input type="file" multiple accept="image/*" onChange={handleFileChange} className="hidden" />
                    </label>
                    <p className="text-xs text-gray-500 mt-1">No file chosen</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Additional Images (Max 5)</label>
                <input
                    type="file"
                    multiple
                    accept="image/*"
                    onChange={handleFileChange}
                    className="hidden"
                    id="additional-images"
                />
                <label 
                    htmlFor="additional-images"
                    className="cursor-pointer text-sm text-blue-600 hover:underline"
                >
                    Choose file
                </label>
                <p className="text-xs text-gray-500 mt-1">No file chosen</p>
                
                {character.avatars?.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-2">
                        {character.avatars.map((avatar, index) => (
                            <img
                                key={index}
                                src={avatar}
                                alt={`Avatar ${index + 1}`}
                                className={`w-12 h-12 rounded-lg object-cover cursor-pointer border-2 ${
                                    character.activeAvatarIndex === index ? 'border-blue-600' : 'border-gray-200'
                                }`}
                                onClick={() => setCharacter(prev => ({ ...prev, activeAvatarIndex: index }))}
                            />
                        ))}
                    </div>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Name *</label>
                <input
                  type="text"
                  value={character.name}
                  onChange={(e) => setCharacter({ ...character, name: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="An" required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Age</label>
                <input
                  type="number"
                  value={character.age}
                  onChange={(e) => setCharacter({ ...character, age: parseInt(e.target.value) || 18 })}
                  min="13"
                  max="100"
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="25" required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Gender</label>
                <select
                  value={character.gender}
                  onChange={(e) => handleGenderChange(e.target.value)}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  {Object.values(Gender).map(g => <option key={g} value={g}>{g}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Act Like</label>
                <select
                  value={character.actLike}
                  onChange={(e) => setCharacter({ ...character, actLike: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  {Object.values(ActLike).map(a => <option key={a} value={a}>{a}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Expert</label>
                <div className="flex flex-wrap gap-2">
                  {Object.values(Expert).map(e => (
                    <button
                      key={e}
                      type="button"
                      onClick={() => handleExpertiseToggle(e)}
                      className={`px-3 py-2 rounded-full text-sm font-medium transition-colors ${
                        character.expertise?.includes(e)
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      {e.replace(/_/g, ' ')}
                    </button>
                  ))}
                </div>
                <p className="text-xs text-gray-500 mt-2">Select expertise areas for your CA. Multiple selections allowed.</p>
              </div>

               <div>
                <label className="block text-sm font-medium text-gray-700">Custom Expertise & Behaviour (Optional)</label>
                 <textarea
                  value={character.customPersonality || ''}
                  onChange={(e) => setCharacter({ ...character, customPersonality: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  rows={3}
                  placeholder="Describe specific expertise not listed above or preferred behavior style (e.g., 'Short answers in bullet points', 'Detailed explanations with examples', 'Focus on practical applications')"
                />
              </div>

              <div className="flex justify-end space-x-2 pt-4">
                <button 
                    type="button" 
                    onClick={onCancel} 
                    className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                    Cancel
                </button>
                <button 
                    type="submit" 
                    className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                >
                    Save Profile
                </button>
              </div>
            </form>
          );
        };

        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
        const GroupSetup = ({ characters, onSave, onCancel }) => {
          const [group, setGroup] = useState({ 
              id: `group_${Date.now()}`, 
              name: '', 
              members: [], 
              messages: [],
              blockCount: 0,
              isBlocked: false
          });

          const handleMemberToggle = (characterId) => {
            setGroup(prev => {
              const members = prev.members.includes(characterId) 
                ? prev.members.filter(id => id !== characterId)
                : [...prev.members, characterId];
              return { ...prev, members };
            });
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if (group.name.trim() === '') {
              alert("Please enter a name for the group.");
              return;
            }
            if (group.members.length === 0) {
              alert("Please select at least one AI profile for the group.");
              return;
            }
            onSave(group);
          };

          return (
            <form onSubmit={handleSubmit} className="p-4 space-y-4">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-center text-gray-700">Create Group Chat</h2>
                <button type="button" onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Group Name</label>
                <input
                  type="text"
                  value={group.name}
                  onChange={(e) => setGroup({ ...group, name: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="E.g., Friends Group" required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Select AI Profiles</label>
                <div className="mt-1 space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2">
                  {characters.map(char => (
                    <label key={char.id} className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={group.members.includes(char.id)}
                        onChange={() => handleMemberToggle(char.id)}
                        className="rounded text-blue-600 focus:ring-blue-500"
                      />
                      <span className="text-sm text-gray-700">{char.name} ({char.relationship})</span>
                    </label>
                  ))}
                </div>
              </div>
              <div className="flex justify-end space-x-2 pt-4">
                <button 
                    type="button" 
                    onClick={onCancel} 
                    className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                    Cancel
                </button>
                <button 
                    type="submit" 
                    className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                >
                    Create Group
                </button>
              </div>
            </form>
          );
        };

        const GroupEdit = ({ group, characters, onSave, onCancel }) => {
            const [editedGroup, setEditedGroup] = useState({ 
                ...group,
                blockCount: group.blockCount || 0,
                isBlocked: group.isBlocked || false
            });

            const handleMemberToggle = (characterId) => {
                setEditedGroup(prev => {
                    const members = prev.members.includes(characterId) 
                        ? prev.members.filter(id => id !== characterId)
                        : [...prev.members, characterId];
                    return { ...prev, members };
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editedGroup.name.trim() === '') {
                    alert("Please enter a name for the group.");
                    return;
                }
                if (editedGroup.members.length === 0) {
                    alert("Please select at least one AI profile for the group.");
                    return;
                }
                onSave(editedGroup);
            };

            return (
                <form onSubmit={handleSubmit} className="p-4 space-y-4">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-center text-gray-700">Edit Group Chat</h2>
                        <button type="button" onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Group Name</label>
                        <input
                            type="text"
                            value={editedGroup.name}
                            onChange={(e) => setEditedGroup({ ...editedGroup, name: e.target.value })}
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="E.g., Friends Group" required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Members</label>
                        <div className="mt-1 space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2">
                            {characters.map(char => (
                                <label key={char.id} className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={editedGroup.members.includes(char.id)}
                                        onChange={() => handleMemberToggle(char.id)}
                                        className="rounded text-blue-600 focus:ring-blue-500"
                                    />
                                    <span className="text-sm text-gray-700">{char.name} ({char.relationship})</span>
                                </label>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-end space-x-2 pt-4">
                        <button 
                            type="button" 
                            onClick={onCancel} 
                            className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                            Save
                        </button>
                    </div>
                </form>
            );
        };

        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
        const Sidebar = ({ isOpen, onClose, characters, groups, onSelectCharacter, onSelectGroup, showIndividual, setShowIndividual }) => {
            if (!isOpen) return null;

            return (
                <>
                    <div className="fixed inset-0 bg-black bg-opacity-50 z-40" onClick={onClose}></div>
                    <div className="fixed left-0 top-0 h-full w-80 bg-white z-50 shadow-lg transform transition-transform">
                        <div className="p-4 border-b">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-bold">Chat History</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                <button
                                    onClick={() => setShowIndividual(true)}
                                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                                        showIndividual ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'
                                    }`}
                                >
                                    Individual
                                </button>
                                <button
                                    onClick={() => setShowIndividual(false)}
                                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                                        !showIndividual ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'
                                    }`}
                                >
                                    Group
                                </button>
                            </div>
                        </div>
                        <div className="p-4 overflow-y-auto h-full">
                            {showIndividual ? (
                                <div className="space-y-2">
                                    {characters.map(char => (
                                        <div
                                            key={char.id}
                                            onClick={() => {
                                                onSelectCharacter(char.id);
                                                onClose();
                                            }}
                                            className="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"
                                        >
                                            <img
                                                src={char.avatars?.[char.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${char.id}`}
                                                alt={char.name}
                                                className="w-10 h-10 rounded-full object-cover"
                                            />
                                            <div className="ml-3">
                                                <p className="font-semibold text-gray-800">{char.name}</p>
                                                <p className="text-sm text-gray-600">{char.relationship}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {groups.map(group => (
                                        <div
                                            key={group.id}
                                            onClick={() => {
                                                onSelectGroup(group.id);
                                                onClose();
                                            }}
                                            className="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"
                                        >
                                            <div className="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center">
                                                <span className="text-blue-800 font-semibold">{group.name[0]}</span>
                                            </div>
                                            <div className="ml-3">
                                                <p className="font-semibold text-gray-800">{group.name}</p>
                                                <p className="text-sm text-gray-600">Group ({group.members.length} members)</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </>
            );
        };

        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
        const ChatScreen = ({ character, userProfile, onCharacterUpdate, onBack, onUserProfileUpdate, backgroundUrl, onSetBackground }) => {

            const TOTAL_API_KEYS = 3; // Example: Agar aapke paas 3 keys hain
          const [messages, setMessages] = useState(character.messages);
          const [isTyping, setIsTyping] = useState(false);
          const [showAiProfile, setShowAiProfile] = useState(false);
          const [showUserProfile, setShowUserProfile] = useState(false);
          const [blockCount, setBlockCount] = useState(character.blockCount || 0);
          const [isBlocked, setIsBlocked] = useState(character.isBlocked || false);
          
          const messagesRef = useRef(messages);
          messagesRef.current = messages;

          useEffect(() => {
            onCharacterUpdate({ ...character, messages, blockCount, isBlocked });
          }, [messages, blockCount, isBlocked]);

       const handleSend = useCallback(async (text, attachments = []) => {
    if (isBlocked) return;

    const userMessage = {
        id: `msg_${Date.now()}`,
        sender: MessageSender.USER,
        text: text,
        attachments: attachments,
        timestamp: Date.now(),
    };
// Step 1: Ek naya variable banayein jo AI ko bheja jayega.
    let messageTextForAI = text;

    // Step 2: Check karein ki attachments hain ya nahi.
    if (attachments && attachments.length > 0) {
      // Step 3: Har file ke content ko format karke message mein jodein.
      const fileContents = attachments.map(file => {
       
  
if (file.type.startsWith('text/') || file.type.includes('json') || file.type.includes('csv') || file.type.includes('pdf') || file.type.includes('wordprocessingml.document') || file.type.startsWith('image/')) {
    return `\n\n--- Attached File: ${file.name} ---\n${file.content}\n--- End of File ---`;
        }
        return ''; // Baaki file types ke liye kuch na jodein
      }).join('');
      
      messageTextForAI += fileContents;
    }

    // Step 4: AI ke liye ek alag message object banayein jisme file content bhi hai.
    // User ko UI mein sirf original text dikhega.
    const messageForAI = { ...userMessage, text: messageTextForAI };



      const updatedMessages = [...messagesRef.current, userMessage];
    setMessages(updatedMessages);
    setIsTyping(true);

    const aiMessageId = `msg_${Date.now() + 1}`;
    setMessages(prev => [...prev, { id: aiMessageId, sender: MessageSender.AI, text: '', timestamp: Date.now() }]);

    const updateStreamingMessage = (chunk) => {
            setMessages(prev =>
                prev.map(msg =>
                    msg.id === aiMessageId ? { ...msg, text: msg.text + (msg.text.endsWith('\n\nSomething went wrong. Please retry.') ? '' : chunk) } : msg
                )
            );
        };

        let success = false;
        let keyIndexToTry = 0;

        // Loop tab tak chalega jab tak success na mil jaaye ya saari keys try na ho jaayein
        while (!success && keyIndexToTry < TOTAL_API_KEYS) {
            // Har baar loop chalne se pehle, check karo ki current keyIndex deactivated to nahi hai
            const deactivatedKeys = await apiKeyManager.getDeactivatedKeys();
            if (deactivatedKeys.some(key => key.index === keyIndexToTry)) {
                console.log(`Key index ${keyIndexToTry} is on cooldown. Skipping.`);
                keyIndexToTry++; // Agli key ka number try karo
                continue; // Loop ka ye wala step skip kardo
            }

            try {
                // Modified function ko call karo aur key ka index bhejo
                const response = await generateChatResponseStream(character, userProfile, updatedMessages, messageForAI, updateStreamingMessage, () => {}, keyIndexToTry);

                if (response.status === 429) {
                    // Agar server ne 429 (Quota Exceeded) bheja
                    
                    const errorData = await response.json();
                    throw { name: 'QuotaError', failedIndex: errorData.failedKeyIndex };
                }

                if (!response.ok) {
                    // Koi aur server error
                    throw new Error(`Server error: ${response.statusText}`);
                }
                
                // Agar response OK (200) hai, to stream ko process karo
                success = true; // Success mark karo taaki loop ruk jaaye
                currentKeyIndex = keyIndexToTry;
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    fullText += chunk;
                    updateStreamingMessage(chunk);
                }

                if (fullText.trim() === '[BLOCK_USER]') {
                    setBlockCount(prev => prev + 1);
                    setIsBlocked(true);
                    setMessages(prev => prev.filter(msg => msg.id !== aiMessageId));
                }

            } catch (error) {
                if (error.name === 'QuotaError') {
                    // Agar QuotaError hai to key ko deactivate karo aur agli key try karo
                    console.warn(`Key at index ${error.failedIndex} failed. Deactivating and trying next.`);
                    await apiKeyManager.deactivateKey(error.failedIndex);
                    keyIndexToTry++; // Agli key ke liye index badhao
                } else {
                    // Agar koi aur error hai to loop rok do
                    console.error("A non-quota error occurred:", error);
                    updateStreamingMessage("\n\nSomething went wrong. Please retry.");
                    break; 
                }
            }
        }

        if (!success) {
            console.error("All API keys failed or were on cooldown.");
            // Agar saari keys fail ho gayi to user ko batao
            setMessages(prev => prev.map(msg => 
                msg.id === aiMessageId && msg.text === '' 
                ? {...msg, text: "All services are currently busy. Please try again later."} 
                : msg
            ));
        }
        
        setIsTyping(false);
    }, [character, userProfile, isBlocked]);

    const [selectedMessages, setSelectedMessages] = useState([]);

    const handleEditMessage = (messageId, newText) => {
        const updatedMessages = messages.map(msg =>
            msg.id === messageId ? { ...msg, text: newText } : msg
        );
        setMessages(updatedMessages);
    };

    const handleDeleteMessage = (messageId) => {
        const updatedMessages = messages.filter(msg => msg.id !== messageId);
        setMessages(updatedMessages);
        setSelectedMessages(prev => prev.filter(id => id !== messageId));
    };

    const handleSelectMessage = (messageId) => {
        setSelectedMessages(prev => 
            prev.includes(messageId) 
                ? prev.filter(id => id !== messageId)
                : [...prev, messageId]
        );
    };

    const handleLongPressMessage = (messageId) => {
        setSelectedMessages(prev => 
            prev.includes(messageId) ? prev : [...prev, messageId]
        );
    };

    const handleDeleteSelected = () => {
        if (selectedMessages.length > 0 && confirm(`Delete ${selectedMessages.length} selected message(s)?`)) {
            const updatedMessages = messages.filter(msg => !selectedMessages.includes(msg.id));
            setMessages(updatedMessages);
            setSelectedMessages([]);
        }
    };

          const handleUnblock = () => {
            if (blockCount >= 3) {
                alert("You have been blocked permanently. This chat will be deleted.");
                setCharacters(prev => prev.filter(c => c.id !== character.id));
                setGroups(prev => prev.map(g => ({
                    ...g,
                    members: g.members.filter(memberId => memberId !== character.id)
                })));
                onBack();
                return;
            }
            setIsBlocked(false);
          };
          
          const handleClearChat = () => {
              if (window.confirm("Are you sure you want to delete all messages in this chat?")) {
                setMessages([]);
                setBlockCount(0);
                setIsBlocked(false);
              }
          }
          
          const handleSaveAiProfile = (updatedCharacter) => {
            onCharacterUpdate({...updatedCharacter, messages, blockCount, isBlocked});
            setShowAiProfile(false);
          }
          
          const handleSaveUserProfile = (profile) => {
            onUserProfileUpdate(profile);
            setShowUserProfile(false);
          }

          return (
             <div className="app-container w-full bg-gray-100">
              <ChatHeader 
                character={character} 
                onBack={onBack} 
                onEditAiProfile={() => setShowAiProfile(true)}
                onEditUserProfile={() => setShowUserProfile(true)}
                onClearChat={handleClearChat}
                onSetBackground={onSetBackground}
              />
                            

              {selectedMessages.length > 0 && (
                <div className="fixed top-20 left-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-20 flex justify-between items-center">
                  <span className="text-sm font-medium">{selectedMessages.length} message(s) selected</span>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setSelectedMessages([])}
                      className="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleDeleteSelected}
                      className="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              )}
              <MessageList 
                messages={messages} 
                character={character} 
                userProfile={userProfile} 
                isTyping={isTyping} 
                backgroundUrl={backgroundUrl}
                onEditMessage={handleEditMessage}
                onDeleteMessage={handleDeleteMessage}
                selectedMessages={selectedMessages}
                onSelectMessage={handleSelectMessage}
                onLongPressMessage={handleLongPressMessage}
                // --- YEH LINES ADD KAREIN ---
                isBlocked={isBlocked}
                blockCount={blockCount}
                characterName={character.name}
                handleUnblock={handleUnblock}
                // --- END ---
              />
              <MessageInput onSend={handleSend} isBlocked={isBlocked} />

              {showAiProfile && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <CharacterSetup
                            initialCharacter={{ ...character, blockCount, isBlocked }}
                            onSave={handleSaveAiProfile}
                            onCancel={() => setShowAiProfile(false)}
                        />
                    </div>
                </div>
              )}

              {showUserProfile && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <UserProfileSetup
                            userProfile={userProfile}
                            onSave={handleSaveUserProfile}
                            onCancel={() => setShowUserProfile(false)}
                        />
                    </div>
                </div>
              )}
            </div>
          );
        };

  const GroupChatScreen = ({ group, characters, userProfile, onGroupUpdate, onBack, onUserProfileUpdate, backgroundUrl, onSetBackground }) => {
    // ==> IMPORTANT: Apni total API keys ka number yahan daalein <==
    const TOTAL_API_KEYS = 3; // Example: Agar aapke paas 3 keys hain

    const [messages, setMessages] = useState(group.messages || []);
    const [isTyping, setIsTyping] = useState(false);
    const [showUserProfile, setShowUserProfile] = useState(false);
    const [showGroupEdit, setShowGroupEdit] = useState(false);
    const [consecutiveSkips, setConsecutiveSkips] = useState(0);
    const [blockCount, setBlockCount] = useState(group.blockCount || 0);
    const [isBlocked, setIsBlocked] = useState(group.isBlocked || false);
    const messagesRef = useRef(messages);
    useEffect(() => { messagesRef.current = messages; }, [messages]);

      // === YAHAN BADLAV KIYA GAYA HAI (START) ===
    // =======================================================================

    // Yeh naya useEffect add kiya gaya hai.
    // Iska kaam hai ki jab bhi messages, blockCount, ya isBlocked state mein koi badlav ho,
    // to yeh group ke poore data ko App component mein update kar de.
    // Isse data refresh karne par ya back jaane par IndexedDB mein save rehta hai.
    useEffect(() => {
        onGroupUpdate({ ...group, messages, blockCount, isBlocked });
    }, [messages, blockCount, isBlocked]); // Dependency array mein states daali gayi hain.

    // =======================================================================
    // === BADLAV KHATAM ===

    const groupMembers = useMemo(() => 
        group.members.map(id => characters.find(c => c.id === id)).filter(Boolean), 
        [group.members, characters]
    );

    

    const handleApiCall = useCallback(async (isSkip, text = '', attachments = []) => {
        if (isBlocked) return;
        
        const isUserListening =  false;
        
         // Step 1: Ek naya variable banayein jo AI ko bheja jayega.
    let messageTextForAI = text;

    // Step 2: Check karein ki attachments hain ya nahi.
    if (!isSkip && attachments && attachments.length > 0) {
        // Step 3: Har file ke content ko format karke message mein jodein.
        const fileContents = attachments.map(file => {
        
if (file.type.startsWith('text/') || file.type.includes('json') || file.type.includes('csv') || file.type.includes('pdf') || file.type.includes('wordprocessingml.document') || file.type.startsWith('image/')) {
                return `\n\n--- Attached File: ${file.name} ---\n${file.content}\n--- End of File ---`;
            }
            return ''; // Baaki file types ke liye kuch na jodein
        }).join('');
        
        messageTextForAI += fileContents;
    }
    
        let latestMessage;
    if (isSkip) {
        let systemText = isUserListening ?
            '[System: User is listening, continue naturally.]' :
            `[System: User skipped. ${consecutiveSkips + 1 >= 2 ? 'User seems unavailable, continue among AIs.' : 'Continue conversation.'}]`;
        latestMessage = {
            text: systemText
        };
    } else {
        latestMessage = {
            id: `msg_${Date.now()}`,
            sender: MessageSender.USER,
            text: text, // UI mein user ko sirf original text dikhega
            attachments: attachments,
            timestamp: Date.now()
        };
    }
         // AI ke liye ek alag message object banayein jisme file content bhi hai.
    const messageForAI = { ...latestMessage, text: messageTextForAI };

        let updatedMessages = [...messagesRef.current];
        if (!isSkip) {
            updatedMessages.push(latestMessage);
            setMessages(updatedMessages);
        }

        setIsTyping(true);
        const currentSkips = isSkip ? consecutiveSkips + 1 : 0;
        setConsecutiveSkips(currentSkips);

        const groupStreamId = `stream_${Date.now()}`;
        setMessages(prev => [...prev, {
        id: groupStreamId,
        sender: 'group',
        text: '',
        timestamp: Date.now()
    }]);

    const updateStreamingMessage = (chunk) => {
        setMessages(prev => prev.map(msg => msg.id === groupStreamId ? { ...msg,
            text: msg.text + chunk
        } : msg));
    };
        
        let success = false;
        let keyIndexToTry = 0;

        while (!success && keyIndexToTry < TOTAL_API_KEYS) {
            const deactivatedKeys = await apiKeyManager.getDeactivatedKeys();
            if (deactivatedKeys.some(key => key.index === keyIndexToTry)) {
                console.log(`Key index ${keyIndexToTry} is on cooldown for group chat. Skipping.`);
                keyIndexToTry++;
                continue;
            }

            try { 
                const response = await generateGroupChatResponseStream(groupMembers, userProfile, updatedMessages, messageForAI, updateStreamingMessage, currentSkips, () => {}, keyIndexToTry);


                if (response.status === 429) {
                    const errorData = await response.json();
                    throw { name: 'QuotaError', failedIndex: errorData.failedKeyIndex };
                }
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                success = true;
                currentKeyIndex = keyIndexToTry;
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    // Streaming UI update yahan nahi hoga, poora response aane ke baad hoga
                    fullResponse += chunk;
                }
                
               

     // Ab poore response ko naye logic se parse karke messages create karo
    if (fullResponse.includes('[BLOCK_USER]')) {
        setBlockCount(prev => prev + 1);
        setIsBlocked(true);
        setMessages(prev => prev.filter(m => m.id !== groupStreamId)); // Temp message hatao
    } else {
        const newMessages = [];
        const lines = fullResponse.split('\n');
        
        // Regex to find lines that start with "Name: "
        // Yeh kisi bhi naam (jisme space ho) ko dhund lega
        const nameRegex = /^([\w\s]+):\s*(.*)/;

        lines.forEach(line => {
            const match = line.match(nameRegex);

            if (match) {
                // Agar line "Name: Message" format mein hai, to yeh ek naya message hai
                const characterName = match[1].trim();
                const messageText = match[2].trim();
                const character = groupMembers.find(c => c.name === characterName);

                if (character) {
                    newMessages.push({
                        id: `msg_${Date.now()}_${Math.random()}`,
                        sender: character.id,
                        text: messageText, // Shuruaati message text
                        timestamp: Date.now()
                    });
                }
            } else if (newMessages.length > 0 && line.trim().length > 0) {
                // Agar line "Name: " se shuru nahi ho rahi, to yeh pichhle message ka hissa hai (multi-line)
                // Pichhle message mein is line ko jod do.
                newMessages[newMessages.length - 1].text += '\n' + line;
            }
        });
        
        // Temp message ko replace karke naye, sahi format wale messages daalo
        setMessages(prev => [...prev.filter(m => m.id !== groupStreamId), ...newMessages.filter(m => m.text)]);
    }

    // =======================================================================
    // === BADLAV KHATAM ===
    // =======================================================================




                
            } catch (error) {
                if (error.name === 'QuotaError') {
                    console.warn(`Key at index ${error.failedIndex} failed for group chat. Deactivating.`);
                    await apiKeyManager.deactivateKey(error.failedIndex);
                    keyIndexToTry++;
                } else {
                    console.error("Group chat API error:", error);
                    setMessages(prev => prev.map(msg => msg.id === groupStreamId ? {...msg, text: "Something went wrong."} : msg));
                    break;
                }
            }
        }
        
        if (!success) {
            console.error("All API keys for group chat failed.");
            setMessages(prev => prev.map(msg => msg.id === groupStreamId ? {...msg, text: "All services are currently busy. Please try again later."} : msg));
        }

        setIsTyping(false);
    }, [groupMembers, userProfile, consecutiveSkips, isBlocked]);
    
    // handleSend aur handleSkip ab naye function ko call karenge
    const handleSend = (text, attachments = []) => handleApiCall(false, text, attachments);
    const handleSkip = () => handleApiCall(true);

    const handleUnblock = () => {
        if (blockCount >= 3) {
            alert("You have been blocked permanently. This group chat will be deleted.");
            // setGroups(prev => prev.filter(g => g.id !== group.id)); // setGroups App component mein hai
            onBack();
            return;
        }
        setIsBlocked(false);
    };

    const handleClearChat = () => {
        if (window.confirm("Are you sure you want to delete all messages in this group chat?")) {
            setMessages([]);
            setBlockCount(0);
            setIsBlocked(false);
        }
    };

    const handleSaveUserProfile = (profile) => {
        onUserProfileUpdate(profile);
        setShowUserProfile(false);
    };

    const handleSaveGroup = (updatedGroup) => {
        onGroupUpdate({ ...updatedGroup, messages, blockCount, isBlocked }); // messages bhi save karo
        setShowGroupEdit(false);
    };

    const [selectedMessages, setSelectedMessages] = useState([]);

    const handleEditMessage = (messageId, newText) => {
        const updatedMessages = messages.map(msg =>
            msg.id === messageId ? { ...msg, text: newText } : msg
        );
        setMessages(updatedMessages);
    };

    const handleDeleteMessage = (messageId) => {
        const updatedMessages = messages.filter(msg => msg.id !== messageId);
        setMessages(updatedMessages);
        setSelectedMessages(prev => prev.filter(id => id !== messageId));
    };

    const handleSelectMessage = (messageId) => {
        setSelectedMessages(prev => 
            prev.includes(messageId) 
                ? prev.filter(id => id !== messageId)
                : [...prev, messageId]
        );
    };

    const handleLongPressMessage = (messageId) => {
        setSelectedMessages(prev => 
            prev.includes(messageId) ? prev : [...prev, messageId]
        );
    };

    const handleDeleteSelected = () => {
        if (selectedMessages.length > 0 && confirm(`Delete ${selectedMessages.length} selected message(s)?`)) {
            const updatedMessages = messages.filter(msg => !selectedMessages.includes(msg.id));
            setMessages(updatedMessages);
            setSelectedMessages([]);
        }
    };

    return (
        <div className="app-container w-full bg-gray-100">
            <header className="fixed-header bg-blue-600 text-white p-3 flex items-center shadow-md">
                <button onClick={onBack} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div className="ml-3 flex-grow">
                    <h2 className="font-semibold text-lg">{group.name}</h2>
                    <p className="text-sm opacity-90">Group Chat • {groupMembers.length} members</p>
                </div>
                <div className="flex items-center gap-1">
                    <button onClick={() => setShowGroupEdit(true)} className="p-2 text-white hover:bg-white/20 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    </button>
                    <button onClick={handleClearChat} className="p-2 text-white hover:bg-white/20 rounded">
                         <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                    <button onClick={() => setShowUserProfile(true)} className="p-2 text-white hover:bg-white/20 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </button>
                </div>
            </header>
                        

            {selectedMessages.length > 0 && (
                <div className="fixed top-20 left-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-20 flex justify-between items-center">
                  <span className="text-sm font-medium">{selectedMessages.length} message(s) selected</span>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setSelectedMessages([])}
                      className="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleDeleteSelected}
                      className="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              )}
            <MessageList 
                messages={messages} 
                characters={characters}
                userProfile={userProfile} 
                isTyping={isTyping} 
                backgroundUrl={backgroundUrl}
                onEditMessage={handleEditMessage}
                onDeleteMessage={handleDeleteMessage}
                selectedMessages={selectedMessages}
                onSelectMessage={handleSelectMessage}
                onLongPressMessage={handleLongPressMessage}
                // --- YEH LINES ADD KAREIN ---
                isBlocked={isBlocked}
                blockCount={blockCount}
                groupName={group.name}
                handleUnblock={handleUnblock}
                // --- END ---
            />
            <MessageInput onSend={handleSend} onSkip={handleSkip} isBlocked={isBlocked} />
            {showUserProfile && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <UserProfileSetup
                            userProfile={userProfile}
                            onSave={handleSaveUserProfile}
                            onCancel={() => setShowUserProfile(false)}
                        />
                    </div>
                </div>
            )}
            {showGroupEdit && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <GroupEdit
                            group={group}
                            characters={characters}
                            onSave={handleSaveGroup}
                            onCancel={() => setShowGroupEdit(false)}
                        />
                    </div>
                </div>
            )}
        </div>
    );
};


        
        /* OBFUSCATION SAFE - This component contains pure UI logic without React elements in system instructions */
        const InstructionsModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl overflow-hidden">
                        <header className="flex items-center justify-between p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">App Guide & Instructions</h2>
                            <button 
                                onClick={onClose} 
                                className="p-2 text-gray-500 hover:text-gray-800 rounded-full hover:bg-gray-100"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </header>
                        <div className="flex-grow overflow-y-auto">
                            {/* Yeh line instructions.html file ko load karegi */}
                            <iframe 
                                src="./instructions.html" 
                                className="w-full h-full border-0"
                                title="Instructions"
                            ></iframe>
                        </div>
                    </div>
                </div>
            );
        };
        const CharacterList = ({ characters, groups, onSelectCharacter, onSelectGroup, setCharacters, setGroups, setUserProfile, setChatBackground, userProfile, chatBackground, isGoogleAuthed, onLogout, onNavigateToUpdates }) => {
          const [isCreating, setIsCreating] = useState(false);
          const [isCreatingGroup, setIsCreatingGroup] = useState(false);
          const [showUserProfile, setShowUserProfile] = useState(false);
          const [showSidebar, setShowSidebar] = useState(false);
          const [showIndividual, setShowIndividual] = useState(true);
        const [showInstructions, setShowInstructions] = useState(false); 
          const importInputRef = useRef(null);

          const handleSaveCharacter = (character) => {
            setCharacters(prev => [...prev, character]);
            setIsCreating(false);
          };

          const handleSaveGroup = (group) => {
            setGroups(prev => [...prev, group]);
            setIsCreatingGroup(false);
            onSelectGroup(group.id);
          };

         const handleDeleteCharacter = (e, id) => {
    e.stopPropagation();
    if (window.confirm("Are you sure you want to delete this AI profile? This will also remove it from all group chats.")) {
        setCharacters(prev => prev.filter(c => c.id !== id));
        setGroups(prev => prev.map(g => ({
            ...g,
            members: g.members.filter(memberId => memberId !== id)
        })).filter(g => g.members.length > 0));
    }
};

const handleSaveUserProfile = (profile) => {
    setUserProfile(profile);
    setShowUserProfile(false);
};

const handleImport = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);

                // Naya code: User profile ko import karo
                if (importedData.userProfile) {
                    setUserProfile(importedData.userProfile);
                }

                if (importedData.characters) {
                    setCharacters(prev => [...prev, ...importedData.characters]);
                }
                if (importedData.groups) {
                    setGroups(prev => [...prev, ...importedData.groups]);
                }
                alert("Data imported successfully!");
            } catch (error) {
                console.error("Import error:", error);
                alert("Failed to import data. Please check the file format.");
            }
        };
        reader.readAsText(file);
    }
};


const handleExport = () => {
    const data = { userProfile, characters, groups };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'TaxFriend_data.json';
    a.click();
    URL.revokeObjectURL(url);
};

return (
    <>
        <div className="flex flex-col h-full bg-blue-600">
                      <header className="bg-blue-600 text-white p-4 pt-8 flex items-center justify-between">
                {/* Left Side Buttons */}
                <div className="flex items-center gap-1">
                    <button onClick={() => setShowSidebar(true)} className="p-2 hover:bg-white/20 rounded">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <button onClick={onLogout} className="p-2 hover:bg-white/20 rounded-full" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>

                {/* Center Title */}
                <h1 className="text-xl font-bold">
                    Virtual Chartered Accountants
                </h1>

                {/* Right Side Buttons */}
                <div className="flex items-center gap-2">
                    <button 
                        onClick={handleAuthClick} 
                        className={`py-1 px-3 rounded-full text-xs font-semibold transition-colors ${ isGoogleAuthed ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-white hover:bg-gray-200 text-blue-600' }`}
                    >
                        {isGoogleAuthed ? 'Drive Connected' : 'Connect to Drive'}
                    </button>
                    {/* --- 2. YEH NAYA 'i' BUTTON ADD KAREIN --- */}
                            <button 
                                onClick={() => setShowInstructions(true)} 
                                className="p-2 rounded-full hover:bg-white/20"
                                title="Instructions"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            {/* --- NAYA BUTTON END --- */}
                    <button onClick={() => setShowUserProfile(true)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                        <img src={userProfile.avatar || `https://i.pravatar.cc/150?u=${userProfile.id}`} alt="Profile" className="w-8 h-8 rounded-full object-cover" />
                    </button>
                </div>
            </header>
            
            <main className="flex-grow bg-white rounded-t-3xl p-4 overflow-y-auto">
    <div className="flex justify-between items-center mb-6">
        <h3 className="text-lg font-bold text-gray-700">Chats</h3>
        <div className="flex gap-2">
            <button
                onClick={() => setIsCreating(true)}
                className="py-2 px-3 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-700"
            >
                New AI
            </button>
            <button
                onClick={() => setIsCreatingGroup(true)}
                className="py-2 px-3 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-700"
            >
                New Group
            </button>
            <button
                                onClick={onNavigateToUpdates} // <-- NAYA ACTION
                                className="py-2 px-3 bg-teal-600 text-white rounded-full text-sm hover:bg-teal-700"
                            >
                                Latest Updates
             </button>
            <button
                onClick={() => importInputRef.current?.click()}
                className="py-2 px-3 bg-gray-600 text-white rounded-full text-sm hover:bg-gray-700"
            >
                Import
            </button>
            <input
                type="file"
                ref={importInputRef}
                accept=".json"
                onChange={handleImport}
                className="hidden"
            />
            <button
                onClick={handleExport}
                className="py-2 px-3 bg-gray-600 text-white rounded-full text-sm hover:bg-gray-700"
            >
                Export
            </button>
        </div>
    </div>
    {characters.length === 0 && groups.length === 0 ? (
        <div className="flex flex-col items-center justify-center h-full">
            <div className="bg-blue-100 rounded-full p-4 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
            </div>
            <h2 className="text-xl text-gray-700">Hey! I'm Tax Dost</h2>
            <p className="text-sm text-gray-500 text-center">Your personal Chartered Accountant. Ask me anything about tax, finance, or investments to get started! 💼</p>
            <button onClick={() => setIsCreating(true)} className="mt-4 py-2 px-4 bg-blue-600 text-white rounded-full">+ New Chat</button>
        </div>
    ) : (
        <div className="space-y-3">
            {characters.map(char => (
                <div
                    key={char.id}
                    onClick={() => onSelectCharacter(char.id)}
                    className="flex items-center p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                >
                    <img
                        src={char.avatars?.[char.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${char.id}`}
                        alt={char.name}
                        className="w-12 h-12 rounded-full object-cover"
                    />
                    <div className="ml-4 flex-grow">
                        <div className="flex items-center justify-between">
                            <p className="font-semibold text-gray-800">{char.name}</p>
                            <span className="text-xs text-gray-500">
                                {char.messages?.length > 0 ? new Date(char.messages[char.messages.length - 1].timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : ''}
                            </span>
                        </div>
                        <div className="flex items-center justify-between mt-1">
                            <p className="text-sm text-gray-600">{char.actLike} • {char.expertise[0] || 'General CA'}</p>

                            <button
                                onClick={(e) => handleDeleteCharacter(e, char.id)}
                                className="p-1 text-red-400 hover:text-red-600"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            ))}
            {groups.map(group => (
                <div
                    key={group.id}
                    onClick={() => onSelectGroup(group.id)}
                    className="flex items-center p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                >
                    <div className="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center">
                        <span className="text-blue-800 font-semibold">{group.name[0]}</span>
                    </div>
                    <div className="ml-4 flex-grow">
                        <div className="flex items-center justify-between">
                            <p className="font-semibold text-gray-800">{group.name}</p>
                            <span className="text-xs text-gray-500">
                                {group.messages?.length > 0 ? new Date(group.messages[group.messages.length - 1].timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : ''}
                            </span>
                        </div>
                        <div className="flex items-center justify-between mt-1">
                            <p className="text-sm text-gray-600">Group ({group.members.length} members)</p>
                            <button
                                onClick={(e) => { e.stopPropagation(); if (window.confirm("Are you sure you want to delete this group?")) { setGroups(prev => prev.filter(g => g.id !== group.id)); } }}
                                className="p-1 text-red-400 hover:text-red-600"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    )}
</main>
        </div>

        <Sidebar
            isOpen={showSidebar}
            onClose={() => setShowSidebar(false)}
            characters={characters}
            groups={groups}
            onSelectCharacter={onSelectCharacter}
            onSelectGroup={onSelectGroup}
            showIndividual={showIndividual}
            setShowIndividual={setShowIndividual}
        />

        {isCreating && (
           <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <CharacterSetup
                        initialCharacter={{
                            id: `char_${Date.now()}`,
                            name: '',
                            actLike: ActLike.FRIEND,
                            gender: Gender.FEMALE,
                            age: 25,
                            expertise: [Expert.TAX_CONSULTANT],
                            avatars: [],
                            defaultAvatar: '01_CAGIRL.png',
                            activeAvatarIndex: 0,
                            messages: [],                         customPersonality: '',
                            blockCount: 0,
                            isBlocked: false
                        }}
                        onSave={handleSaveCharacter}
                        onCancel={() => setIsCreating(false)}
                    />
                </div>
            </div>
        )}
        {isCreatingGroup && (
            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <GroupSetup
                        characters={characters}
                        onSave={handleSaveGroup}
                        onCancel={() => setIsCreatingGroup(false)}
                    />
                </div>
            </div>
        )}
        {showUserProfile && (
            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <UserProfileSetup
                        userProfile={userProfile}
                        onSave={handleSaveUserProfile}
                        onCancel={() => setShowUserProfile(false)}
                    />
                </div>
            </div>
        )}
        <InstructionsModal 
            isOpen={showInstructions} 
            onClose={() => setShowInstructions(false)} 
        />
    </>
);
};





// --- NAYA COMPONENT 1: CardForm (Create/Edit Card Screen) ---
const CardForm = ({ initialCard, onSave, onCancel }) => {
    // Agar 'initialCard' hai, to hum "Edit" mode mein hain
    // Agar nahi hai, to hum "Create" mode mein hain
    const [card, setCard] = useState(initialCard || {
        id: `card_${Date.now()}`,
        name: '',
        topic: '',
        description: '',
        emoji: '📄'
    });

    const EMOJI_OPTIONS = ['📄', '📅', '📈', '💡', '📰', '💼', '📊', '🔔'];

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!card.name.trim() || !card.topic.trim()) {
            alert("Card Name and Topic/Keywords are required.");
            return;
        }
        onSave(card);
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-gray-500 via-gray-700 to-gray-900 flex items-center justify-center p-4">
            <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl p-8 w-full max-w-md">
                <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">
                    {initialCard ? "Edit Update Card" : "Create New Update Card"}
                </h1>
                
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Card Name</label>
                        <input
                            type="text"
                            value={card.name}
                            onChange={(e) => setCard({ ...card, name: e.target.value })}
                            placeholder="e.g., My GST Tracker"
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Topic / Keywords (for Google Search)</label>
                        <input
                            type="text"
                            value={card.topic}
                            onChange={(e) => setCard({ ...card, topic: e.target.value })}
                            placeholder="e.g., Latest GST notifications India"
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Description (Optional)</label>
                         <textarea
                            value={card.description}
                            onChange={(e) => setCard({ ...card, description: e.target.value })}
                            rows={3}
                            placeholder="What does this card track?"
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Select Icon</label>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {EMOJI_OPTIONS.map(emoji => (
                                <button
                                    key={emoji}
                                    type="button"
                                    onClick={() => setCard({ ...card, emoji: emoji })}
                                    className={`text-2xl p-2 rounded-lg ${
                                        card.emoji === emoji ? 'bg-blue-500 ring-2 ring-blue-700' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {emoji}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-end space-x-2 pt-4">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                            Save Card
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// --- NAYA COMPONENT 2: CardViewScreen (Updates Dikhane ki Screen) ---
const CardViewScreen = ({ card, onBack }) => {
    const [updates, setUpdates] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    
    const fetchUpdates = async () => {
        setIsLoading(true);
        setError(null);
        setUpdates([]);
        try {

            const keyIndexToUse = currentKeyIndex;

            const response = await fetch('/api/get-updates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // 2. Ab 'currentKeyIndex' variable ka istemal karein (jo ab defined hai)
                body: JSON.stringify({ topic: card.topic, keyIndex: keyIndexToUse })
            });
            
            if (!response.ok) {
                // 429 Quota Exceeded error ko alag se handle karein
                if (response.status === 429) {
                    // Yahan aap key rotation logic ko call kar sakte hain, agar zaroorat ho
                    throw new Error("Quota exceeded for this API key. Please try again later.");
                }
                throw new Error(`Server error: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (data.updates) {
                setUpdates(data.updates);
            } else {
                setError(data.error || "Failed to get updates.");
            }
            
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };
    
    // Screen load hote hi updates fetch karein
    useEffect(() => {
        fetchUpdates();
    }, [card]); // Card badalne par bhi fetch karega
    
    return (
        <div className="app-container w-full bg-gray-100">
            <header className="fixed-header bg-blue-600 text-white p-3 flex items-center shadow-md">
                <button onClick={onBack} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div className="ml-3 flex-grow">
                    <h2 className="font-semibold text-lg">{card.emoji} {card.name}</h2>
                    <p className="text-sm opacity-90 truncate">{card.topic}</p>
                </div>
                <button
                    onClick={fetchUpdates}
                    disabled={isLoading}
                    className="p-2 rounded-full hover:bg-white/20 disabled:opacity-50"
                    title="Refresh Updates"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 ${isLoading ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                    </svg>
                </button>
            </header>
            
            <main className="message-container p-4">
                {card.description && (
                    <div className="p-3 bg-white rounded-lg shadow mb-4">
                        <p className="text-sm text-gray-700 italic">{card.description}</p>
                    </div>
                )}
                
                {isLoading && (
                    <div className="flex justify-center items-center h-32">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                        <p className="ml-3 text-gray-600">Fetching latest updates...</p>
                    </div>
                )}
                
                {error && (
                     <div className="p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <p className="font-bold">Error:</p>
                        <p>{error}</p>
                    </div>
                )}
                
                {!isLoading && !error && updates.length === 0 && (
                    <div className="p-3 bg-blue-100 border border-blue-300 text-blue-800 rounded-lg text-center">
                        <p>No significant updates found for today.</p>
                    </div>
                )}
                
                {!isLoading && !error && updates.length > 0 && (
                    <div className="space-y-3">
                        {updates.map((update, index) => (
                            <div key={index} className="p-4 bg-white rounded-xl shadow-md flex items-start gap-3">
                                <span className="text-blue-500 font-bold text-lg">{index + 1}.</span>
                                <p className="text-gray-800">{update}</p>
                            </div>
                        ))}
                    </div>
                )}
            </main>
        </div>
    );
};

// --- NAYA COMPONENT 3: UpdatesDashboardScreen (Main Updates Screen) ---
const UpdatesDashboardScreen = ({ cards, onNavigateBack, onNavigateToForm, onNavigateToView, onCardUpdate, onCardDelete }) => {
    
    const handleEdit = (e, card) => {
        e.stopPropagation(); // Card par click hone se rokein
        onNavigateToForm(card);
    };
    
    const handleDelete = (e, cardId) => {
        e.stopPropagation(); // Card par click hone se rokein
        if (window.confirm("Are you sure you want to delete this update card?")) {
            onCardDelete(cardId);
        }
    };
    
    return (
        <div className="flex flex-col h-full bg-blue-600">
            <header className="bg-blue-600 text-white p-4 pt-8 flex items-center justify-between">
                <button onClick={onNavigateBack} className="p-2 hover:bg-white/20 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 className="text-xl font-bold">Latest Updates</h1>
                <div className="w-10"></div> {/* Spacer */}
            </header>
            
            <main className="flex-grow bg-white rounded-t-3xl p-4 overflow-y-auto">
                {cards.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full">
                        <div className="bg-blue-100 rounded-full p-4 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-4-4h2" />
                            </svg>
                        </div>
                        <h2 className="text-xl text-gray-700">Create your first Update Card</h2>
                        <p className="text-sm text-gray-500 text-center">Track daily news on topics that matter to you.</p>
                        <button onClick={() => onNavigateToForm(null)} className="mt-4 py-2 px-4 bg-blue-600 text-white rounded-full">
                            + Create Card
                        </button>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {cards.map(card => (
                            <div
                                key={card.id}
                                onClick={() => onNavigateToView(card)}
                                className="flex items-center p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                            >
                                <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                    <span className="text-3xl">{card.emoji}</span>
                                </div>
                                <div className="ml-4 flex-grow min-w-0">
                                    <p className="font-semibold text-gray-800 truncate">{card.name}</p>
                                    <p className="text-sm text-gray-600 truncate">{card.topic}</p>
                                </div>
                                <div className="flex-shrink-0 flex gap-1 ml-2">
                                    <button
                                        onClick={(e) => handleEdit(e, card)}
                                        className="p-2 text-blue-500 hover:bg-blue-100 rounded-full"
                                        title="Edit Card"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                    <button
                                        onClick={(e) => handleDelete(e, card.id)}
                                        className="p-2 text-red-500 hover:bg-red-100 rounded-full"
                                        title="Delete Card"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {/* Floating Action Button */}
                {cards.length > 0 && (
                    <button
                        onClick={() => onNavigateToForm(null)}
                        className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700"
                        title="Create New Card"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                )}
            </main>
        </div>
    );
};
        
/* OBFUSCATION SAFE - This is the main app component without system instruction dependencies */

const DrivePromptModal = ({ onConnect, onSkip }) => {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Sync Your Data</h2>
                <p className="text-gray-600 mb-6">
                    Connect to Google Drive to securely back up and sync your chat history across devices.
                </p>
                <div className="flex flex-col gap-3">
                    <button
                        onClick={onConnect}
                        className="w-full py-3 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors"
                    >
                        Continue with Google Drive
                    </button>
                    <button
                        onClick={onSkip}
                        className="w-full py-2 px-4 rounded-lg font-semibold text-gray-500 hover:bg-gray-200 transition-colors"
                    >
                        Continue without Drive
                    </button>
                </div>
            </div>
        </div>
    );
};


// --- NAYA APP COMPONENT START ---
const App = () => {
    // --- SABHI STATES ---
    const [userProfile, setUserProfile] = useState({ id: `user_${Date.now()}`, name: 'Alex', age: 25, gender: Gender.MALE, avatar: '01_CABOY.png' });
    const [characters, setCharacters] = useState([]);
    const [groups, setGroups] = useState([]);
    const [updateCards, setUpdateCards] = useState([]);
    
    // Loading aur Auth states
    const [isDataLoaded, setIsDataLoaded] = useState(false);
    const [loadingProgress, setLoadingProgress] = useState(0);
    const [chatBackground, setChatBackground] = useState(null);
    const [isGoogleAuthed, setIsGoogleAuthed] = useState(false);
    
    // === BADLAAV 1: Nayi States ===
    const [secretCode, setSecretCode] = useState(null);
    const [isAuthLoading, setIsAuthLoading] = useState(true); // <-- YEH NAYI STATE HAI
    
    const [showDrivePrompt, setShowDrivePrompt] = useState(false);
    
    const [currentView, setCurrentView] = useState({ screen: 'chats' }); 

    // Refs
    const exportIntervalRef = useRef(null);
    const inactivityTimerRef = useRef(null);

    // --- EFFECT 1: Data ko IndexedDB se Load Karna ---
    useEffect(() => {
        const loadAllData = async () => {
            try {
                console.log("Loading all data from IndexedDB...");
                setLoadingProgress(10);
                const savedProfile = await window.chatbotStorage.getUserProfile();
                if (savedProfile) setUserProfile(savedProfile);
                setLoadingProgress(25);
                
                const savedChars = await window.chatbotStorage.getCharacters();
                if (savedChars) setCharacters(savedChars);
                setLoadingProgress(50);
                
                const savedGroups = await window.chatbotStorage.getGroups();
                if (savedGroups) setGroups(savedGroups);
                setLoadingProgress(75);

                const savedCards = await window.chatbotStorage.getUpdateCards();
                if (savedCards) setUpdateCards(savedCards);
                setLoadingProgress(100);

                setTimeout(() => setIsDataLoaded(true), 500);
            } catch (error) {
                console.error('Error loading data:', error);
                setIsDataLoaded(true);
            }
        };
        loadAllData();
    }, []);

    // === BADLAAV 2: Naya useEffect (Secret Code Check) ===
    useEffect(() => {
        const loadSecretCode = async () => {
            let saved = null;
            try {
                // Pehle localStorage (fallback) check karein
                saved = localStorage.getItem('temp_secret_code');
                if (saved) {
                    localStorage.removeItem('temp_secret_code'); // Istemal karke delete karein
                    // Isse IndexedDB mein bhi save kar dein
                    if (window.chatbotStorage) {
                        await window.chatbotStorage.setSecretCode(saved);
                    }
                } else if (window.chatbotStorage) {
                    // Phir IndexedDB check karein
                    saved = await window.chatbotStorage.getSecretCode();
                }

                if (saved) {
                    console.log("Found saved secret code.");
                    setSecretCode(saved);
                    setIsAuthLoading(false); // Auth check poora hua
                } else {
                    // Koi code nahi mila, login par waapas bhejo
                    console.log("No secret code found. Redirecting to home");
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error loading secret code:', error);
                // Koi bhi error aaye, login par waapas bhejo
                window.location.href = '/';
            }
        };
        
        // Yeh tab tak nahi chalega jab tak IndexedDB script load na ho (isDataLoaded par depend kar sakte hain)
        if (isDataLoaded) {
           loadSecretCode();
        } else {
            // Failsafe agar isDataLoaded late hota hai
            // Pehle hi check kar lo
            setTimeout(loadSecretCode, 200); // Thoda wait karke check karo
        }

    }, [isDataLoaded]); // Yeh isDataLoaded par depend karega
    
    // --- EFFECTS 3: Data ko Automatically IndexedDB mein Save Karna ---
    useEffect(() => {
        if (isDataLoaded && userProfile && userProfile.id) {
            window.chatbotStorage.setUserProfile(userProfile);
        }
    }, [userProfile, isDataLoaded]);

    useEffect(() => {
        if (isDataLoaded && characters) {
            window.chatbotStorage.setCharacters(characters);
        }
    }, [characters, isDataLoaded]);

    useEffect(() => {
        if (isDataLoaded && groups) {
            window.chatbotStorage.setGroups(groups);
        }
    }, [groups, isDataLoaded]);
    
    useEffect(() => {
        if (isDataLoaded && updateCards) {
            window.chatbotStorage.setUpdateCards(updateCards);
        }
    }, [updateCards, isDataLoaded]);

    useEffect(() => {
        // Secret code ko save karne ki zaroorat nahi,
        // kyunki vo sirf load hota hai ya logout par clear hota hai
    }, [secretCode]);

    // --- GOOGLE DRIVE SYNC FUNCTIONS ---
    const runExport = async () => {
        if (!secretCode || !isGoogleAuthed) return;
        const dataToExport = await window.chatbotStorage.getAllData(); 

        if (!dataToExport.userProfile) {
            console.log("Export skipped: User profile not found.");
            return;
        }
        
        console.log("🚀 Syncing data with Google Drive...");
        const mainFolderId = await googleDriveService.findOrCreateFolder('Virtual Tax Friend Data');
        if (!mainFolderId) return;

        const fileName = `TaxFriend_data.json`;
        const existingFileId = await googleDriveService.findFileByName(fileName, mainFolderId);

        if (existingFileId) {
            await googleDriveService.updateJsonFile(existingFileId, dataToExport);
        } else {
            await googleDriveService.uploadJsonFile(fileName, dataToExport, mainFolderId);
        }
    };  

    const runImport = async () => {
        console.log("📥 Checking for data to import...");
        const mainFolderId = await googleDriveService.findOrCreateFolder('Virtual Tax Friend Data');
        if (!mainFolderId) return;

        const fileName = `TaxFriend_data.json`;
        const fileId = await googleDriveService.findFileByName(fileName, mainFolderId);
        
        if (fileId) {
            const data = await googleDriveService.getFileContent(fileId);
            
            if (data && typeof data === 'object') {
                console.log("✅ Data found on Drive, importing...");
                const validData = {
                    userProfile: data.userProfile || null,
                    characters: Array.isArray(data.characters) ? data.characters : [],
                    groups: Array.isArray(data.groups) ? data.groups : [],
                    updateCards: Array.isArray(data.updateCards) ? data.updateCards : []
                };
                
                await window.chatbotStorage.setAllData(validData);
                
                if (validData.userProfile) setUserProfile(validData.userProfile);
                setCharacters(validData.characters);
                setGroups(validData.groups);
                setUpdateCards(validData.updateCards);

                if (!sessionStorage.getItem('importAlertShown')) {
                    alert("Chat history and data imported from Google Drive!");
                    sessionStorage.setItem('importAlertShown', 'true');
                }
            } else {
                 console.warn("⚠️ Import skipped: Data from Drive was empty or corrupted.");
            }
        } else {
            console.log(`No previous data found on Drive.`);
        }
    };

    // --- EFFECT 4: BAAKI KE USEEFFECTS ---
    useEffect(() => {
        const handleGoogleAuth = () => setIsGoogleAuthed(true);
        const handleGoogleSignOut = () => setIsGoogleAuthed(false);
        window.addEventListener('google-authed', handleGoogleAuth);
        window.addEventListener('google-signed-out', handleGoogleSignOut);
        return () => {
            window.removeEventListener('google-authed', handleGoogleAuth);
            window.removeEventListener('google-signed-out', handleGoogleSignOut);
        };
    }, []);
    
    useEffect(() => {
        if (isGoogleAuthed && secretCode) {
            console.log("Google Auth is active. Starting import and auto-export interval.");
            runImport();
            if (exportIntervalRef.current) clearInterval(exportIntervalRef.current);
            exportIntervalRef.current = setInterval(runExport, 30000);
            return () => {
                if (exportIntervalRef.current) clearInterval(exportIntervalRef.current);
            };
        }
    }, [isGoogleAuthed, secretCode]);

    useEffect(() => {
        const resetInactivityTimer = () => {
            if (inactivityTimerRef.current) clearTimeout(inactivityTimerRef.current);
            inactivityTimerRef.current = setTimeout(() => {
                alert("You have been logged out due to inactivity.");
                handleLogout();
            }, 3600000); // 1 Ghanta
        };
        if (secretCode) {
            const events = ['mousemove', 'keypress', 'click', 'scroll'];
            events.forEach(event => window.addEventListener(event, resetInactivityTimer));
            resetInactivityTimer();
            return () => {
                events.forEach(event => window.removeEventListener(event, resetInactivityTimer));
                if (inactivityTimerRef.current) clearTimeout(inactivityTimerRef.current);
            };
        }
    }, [secretCode]);

    // --- HANDLER FUNCTIONS ---
    
    // === BADLAAV 3: Updated handleLogout ===
    const handleLogout = async () => {
        console.log("Logging out...");
        if (window.gapiAccessToken) {
            google.accounts.oauth2.revoke(window.gapiAccessToken.access_token);
            window.gapiAccessToken = null;
            if (window.chatbotStorage) await window.chatbotStorage.removeAuthToken();
            setIsGoogleAuthed(false);
        }
        setSecretCode(null);
        if (window.chatbotStorage) await window.chatbotStorage.removeSecretCode();
        
        sessionStorage.removeItem('importAlertShown');
        if (exportIntervalRef.current) clearInterval(exportIntervalRef.current);
        if (inactivityTimerRef.current) clearTimeout(inactivityTimerRef.current);
        
        // Seedha index.html par bhej do
        window.location.href = '/';
    };

    // handleAuthenticated function yahaan nahi hona chahiye (delete kar dein)

    const handleSaveCard = (cardToSave) => {
        setUpdateCards(prevCards => {
            const cardExists = prevCards.some(c => c.id === cardToSave.id);
            if (cardExists) {
                return prevCards.map(c => c.id === cardToSave.id ? cardToSave : c);
            } else {
                return [...prevCards, cardToSave];
            }
        });
        setCurrentView({ screen: 'updates-dashboard' });
    };

    const handleDeleteCard = (cardId) => {
        setUpdateCards(prevCards => prevCards.filter(c => c.id !== cardId));
    };

    // --- RENDERING LOGIC ---
    
    // === BADLAAV 4: Updated Render Logic ===
    if (!isDataLoaded || isAuthLoading) { // <-- MODIFIED CHECK
        return (
            <div className="h-screen flex flex-col justify-center items-center bg-gray-100">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <h2 className="text-xl font-semibold text-gray-700">
                        {isAuthLoading ? 'Authenticating...' : 'Loading Your CA...'}
                    </h2>
                    <div className="w-64 bg-gray-200 rounded-full h-2">
                        <div 
                            className="bg-blue-500 h-2 rounded-full transition-all" 
                            style={{ width: `${loadingProgress}%` }}
                        ></div>
                    </div>
                </div>
            </div>
        );
    }

    // secretCode wala login check yahaan nahi hai (bilkul sahi)

    if (!userProfile.name) {
        return <UserProfileSetup userProfile={userProfile} onSave={setUserProfile} isInitialSetup={true} />;
    }
    
    const renderCurrentView = () => {
        switch (currentView.screen) {
            case 'chats':
                return (
                    <CharacterList
                        characters={characters}
                        groups={groups}
                        onSelectCharacter={(id) => setCurrentView({ screen: 'chat-single', id })}
                        onSelectGroup={(id) => setCurrentView({ screen: 'chat-group', id })}
                        onNavigateToUpdates={() => setCurrentView({ screen: 'updates-dashboard' })}
                        setCharacters={setCharacters}
                        setGroups={setGroups}
                        setUserProfile={setUserProfile}
                        setChatBackground={setChatBackground}
                        userProfile={userProfile}
                        chatBackground={chatBackground}
                        isGoogleAuthed={isGoogleAuthed}
                        onLogout={handleLogout}
                    />
                );
            case 'chat-single':
                const singleChar = characters.find(c => c.id === currentView.id);
                if (!singleChar) {
                    setCurrentView({ screen: 'chats' });
                    return null;
                }
                return (
                    <ChatScreen
                        character={singleChar}
                        userProfile={userProfile}
                        onCharacterUpdate={(updatedCharacter) => setCharacters(prev => prev.map(c => c.id === updatedCharacter.id ? updatedCharacter : c))}
                        onBack={() => setCurrentView({ screen: 'chats' })}
                        onUserProfileUpdate={setUserProfile}
                        backgroundUrl={chatBackground}
                        onSetBackground={setChatBackground}
                    />
                );
            case 'chat-group':
                 const group = groups.find(g => g.id === currentView.id);
                 if (!group) {
                    setCurrentView({ screen: 'chats' });
                    return null;
                 }
                return (
                    <GroupChatScreen
                        group={group}
                        characters={characters}
                        userProfile={userProfile}
                        onGroupUpdate={(updatedGroup) => setGroups(prev => prev.map(g => g.id === updatedGroup.id ? updatedGroup : g))}
                        onBack={() => setCurrentView({ screen: 'chats' })}
                        onUserProfileUpdate={setUserProfile}
                        backgroundUrl={chatBackground}
                        onSetBackground={setChatBackground}
                    />
                );
            case 'updates-dashboard':
                return (
                    <UpdatesDashboardScreen
                        cards={updateCards}
                        onNavigateBack={() => setCurrentView({ screen: 'chats' })}
                        onNavigateToForm={(card) => setCurrentView({ screen: 'updates-form', card: card })}
                        onNavigateToView={(card) => setCurrentView({ screen: 'updates-view', card: card })}
                        onCardUpdate={handleSaveCard}
                        onCardDelete={handleDeleteCard}
                    />
                );
            case 'updates-form':
                return (
                    <CardForm
                        initialCard={currentView.card}
                        onSave={handleSaveCard}
                        onCancel={() => setCurrentView({ screen: 'updates-dashboard' })}
                    />
                );
            case 'updates-view':
                 if (!currentView.card) {
                    setCurrentView({ screen: 'updates-dashboard' });
                    return null;
                 }
                return (
                    <CardViewScreen
                        card={currentView.card}
                        onBack={() => setCurrentView({ screen: 'updates-dashboard' })}
                    />
                );
            default:
                setCurrentView({ screen: 'chats' });
                return null;
        }
    };

    return (
        <div className="app-container">
            {showDrivePrompt && (
                <DrivePromptModal 
                    onConnect={() => {
                        handleAuthClick(); // Global function
                        setShowDrivePrompt(false);
                    }}
                    onSkip={() => setShowDrivePrompt(false)}
                />
            )}
            {renderCurrentView()}
        </div>
    );
};
// --- NAYA APP COMPONENT END ---


// --- RENDER ---
// Main Application Wrapper with Authentication

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);


    </script>
</body>
</html>
